<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#09090b">
    <title>Loja de APKs Privada</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
    <link rel="icon" type="image/png" href="favicon.png?v=2">
    <link rel="icon" type="image/svg+xml" href="favicon.svg?v=2">
    <link rel="apple-touch-icon" href="apple-touch-icon.png?v=2">
    <link rel="manifest" href="manifest.json">
    <!-- TailwindCSS Pre-compiled (compatível com Chrome 55+) -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Polyfill para browsers antigos -->
    <script>
        // Polyfill Promise.allSettled para Chrome 55
        if (!Promise.allSettled) {
            Promise.allSettled = function (promises) {
                return Promise.all(promises.map(function (p) {
                    return Promise.resolve(p).then(
                        function (value) { return { status: 'fulfilled', value: value }; },
                        function (reason) { return { status: 'rejected', reason: reason }; }
                    );
                }));
            };
        }
        // Polyfill Array.prototype.find para Chrome antigo
        if (!Array.prototype.find) {
            Array.prototype.find = function (predicate) {
                for (var i = 0; i < this.length; i++) {
                    if (predicate(this[i], i, this)) return this[i];
                }
                return undefined;
            };
        }
        // Polyfill String.prototype.includes
        if (!String.prototype.includes) {
            String.prototype.includes = function (search) {
                return this.indexOf(search) !== -1;
            };
        }
        // Polyfill Array.prototype.includes
        if (!Array.prototype.includes) {
            Array.prototype.includes = function (search) {
                return this.indexOf(search) !== -1;
            };
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Supabase será carregado opcionalmente, fallback para REST API -->
    <style>
        /* shadcn/ui inspired design system - Zinc palette */
        :root {
            --bg-primary: #09090b;
            --bg-card: #18181b;
            --border: #27272a;
            --text-primary: #fafafa;
            --text-muted: #a1a1aa;
            --accent: #facc15;
        }

        /* Zinc Color Classes (Tailwind 3.x compatível com Tailwind 2.x) */
        .bg-zinc-50 {
            background-color: #fafafa;
        }

        .bg-zinc-100 {
            background-color: #f4f4f5;
        }

        .bg-zinc-200 {
            background-color: #e4e4e7;
        }

        .bg-zinc-300 {
            background-color: #d4d4d8;
        }

        .bg-zinc-400 {
            background-color: #a1a1aa;
        }

        .bg-zinc-500 {
            background-color: #71717a;
        }

        .bg-zinc-600 {
            background-color: #52525b;
        }

        .bg-zinc-700 {
            background-color: #3f3f46;
        }

        .bg-zinc-800 {
            background-color: #27272a;
        }

        .bg-zinc-900 {
            background-color: #18181b;
        }

        .bg-zinc-950 {
            background-color: #09090b;
        }

        .text-zinc-50 {
            color: #fafafa;
        }

        .text-zinc-100 {
            color: #f4f4f5;
        }

        .text-zinc-200 {
            color: #e4e4e7;
        }

        .text-zinc-300 {
            color: #d4d4d8;
        }

        .text-zinc-400 {
            color: #a1a1aa;
        }

        .text-zinc-500 {
            color: #71717a;
        }

        .text-zinc-600 {
            color: #52525b;
        }

        .text-zinc-950 {
            color: #09090b;
        }

        .border-zinc-700 {
            border-color: #3f3f46;
        }

        .border-zinc-800 {
            border-color: #27272a;
        }

        .hover\:bg-zinc-600:hover {
            background-color: #52525b;
        }

        .hover\:bg-zinc-700:hover {
            background-color: #3f3f46;
        }

        .hover\:border-zinc-700:hover {
            border-color: #3f3f46;
        }

        .hover\:text-zinc-50:hover {
            color: #fafafa;
        }

        /* z-index classes */
        .z-\[100\] {
            z-index: 100;
        }

        /* Line clamp for descriptions */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* Focus styles for D-Pad navigation */
        .focusable:focus {
            outline: 4px solid var(--accent);
            transform: scale(1.05);
            z-index: 10;
        }

        /* Smooth transitions */
        .focusable {
            transition: all 0.2s ease;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-card);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        /* Modal overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        .toast.success {
            background-color: #064e3b;
            border-color: #065f46;
            color: #ecfdf5;
        }

        .toast.error {
            background-color: #7f1d1d;
            border-color: #991b1b;
            color: #fef2f2;
        }

        /* Hide elements */
        .hidden {
            display: none !important;
        }

        /* Animação de brilho pulsante para o Banner */
        @keyframes pulse-yellow {
            0% {
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7);
                transform: scale(1);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(250, 204, 21, 0);
                transform: scale(1.02);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0);
                transform: scale(1);
            }
        }

        .animate-glow {
            animation: pulse-yellow 2s infinite;
        }

        /* Garante que o banner se destaque sobre qualquer conteúdo */
        #installBanner {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Fixed icon container to prevent Layout Shift on TV Box */
        .app-icon-container {
            width: 64px;
            height: 64px;
            min-width: 64px;
            min-height: 64px;
            background-color: #27272a;
            border-radius: 0.375rem;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .app-icon-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .app-icon-container img.loaded {
            opacity: 1;
        }

        .app-icon-container .icon-fallback {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        .app-icon-container img.loaded+.icon-fallback {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- PWA Install Banner -->
    <div id="installBanner"
        class="fixed bottom-8 left-4 right-4 z-[100] bg-zinc-900 border-2 border-yellow-500 p-5 rounded-2xl animate-glow">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-yellow-500 rounded-xl flex items-center justify-center text-3xl shadow-lg">
                    📲
                </div>
                <div>
                    <h4 class="font-bold text-zinc-50 text-lg">Instalar Aplicativo</h4>
                    <p class="text-sm text-zinc-400">Adicione à tela inicial da sua TV Box</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="closeInstallBanner()"
                    class="focusable px-4 py-2 text-zinc-400 hover:text-zinc-200 font-medium">
                    Depois
                </button>
                <button onclick="installPWA()"
                    class="focusable px-6 py-3 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-black rounded-xl shadow-lg transition-transform active:scale-95">
                    INSTALAR AGORA
                </button>
            </div>
        </div>
    </div>

    <!-- Store View -->
    <div id="storeView" class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-3xl font-bold text-zinc-50">Loja de APKs</h1>
                <div class="flex gap-2">
                    <button onclick="openHelpModal()"
                        class="focusable px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-50 rounded-md border border-zinc-700 text-sm">
                        Ajuda
                    </button>
                    <button onclick="navigateTo('#/admin')"
                        class="focusable px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-50 rounded-md border border-zinc-700 text-sm">
                        Admin
                    </button>
                </div>
            </div>
            <!-- Search bar -->
            <input type="text" id="searchInput" placeholder="Buscar aplicativos..."
                class="focusable w-full px-4 py-3 bg-zinc-900 border border-zinc-800 rounded-md text-zinc-50 placeholder-zinc-500 focus:border-zinc-700"
                oninput="filterApps()">
            <!-- Filters -->
            <div class="flex flex-wrap gap-3 mt-3">
                <select id="categoryFilter" onchange="filterApps()"
                    class="focusable px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-md text-zinc-50 text-sm">
                    <option value="">Todas as categorias</option>
                </select>
                <select id="sortOrder" onchange="filterApps()"
                    class="focusable px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-md text-zinc-50 text-sm">
                    <option value="recent">Mais recentes</option>
                    <option value="name_asc">Nome A-Z</option>
                    <option value="name_desc">Nome Z-A</option>
                    <option value="rating">Melhor avaliados</option>
                </select>
                <span id="appCount" class="text-zinc-500 text-sm self-center ml-auto"></span>
            </div>
        </header>

        <!-- APK List -->
        <div id="appList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Apps will be loaded here -->
        </div>

        <!-- Loading state -->
        <div id="storeLoading" class="text-center py-12">
            <div class="spinner mx-auto"></div>
            <p class="text-zinc-500 mt-4">Carregando aplicativos...</p>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="hidden text-center py-12">
            <p class="text-zinc-500">Nenhum aplicativo encontrado.</p>
        </div>
    </div>

    <!-- Admin Login View -->
    <div id="adminLoginView" class="hidden container mx-auto px-4 py-6 max-w-md">
        <div class="bg-zinc-900 border border-zinc-800 rounded-md p-8">
            <h2 class="text-2xl font-bold mb-6 text-zinc-50">Admin Login</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">PIN de Acesso</label>
                    <input type="password" id="pinInput"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Digite o PIN">
                </div>
                <button onclick="validatePIN()"
                    class="focusable w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                    Entrar
                </button>
                <button onclick="openSetupModal()"
                    class="focusable w-full px-4 py-2 bg-blue-600 hover:bg-blue-500 text-zinc-50 rounded-md">
                    Configurar Credenciais
                </button>
                <button onclick="navigateTo('#/')"
                    class="focusable w-full px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-50 rounded-md border border-zinc-700">
                    Voltar
                </button>
            </div>
            <div id="loginError"
                class="hidden mt-4 p-3 bg-red-950 border border-red-900 rounded-md text-red-200 text-sm"></div>
            <div class="mt-4 p-3 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-400 text-xs">
                <p><strong>Primeira vez?</strong> Clique em "Configurar Credenciais" para adicionar suas chaves do
                    Supabase e GitHub antes de fazer login.</p>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard View -->
    <div id="toast" class="toast"></div>
    <div id="adminDashboardView" class="hidden container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-zinc-50">Painel Admin</h1>
            <div class="flex gap-2">
                <button onclick="navigateTo('#/')"
                    class="focusable px-4 py-2 bg-blue-600 hover:bg-blue-500 text-zinc-50 rounded-md">
                    🏠 Home
                </button>
                <button onclick="logout()"
                    class="focusable px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-50 rounded-md border border-zinc-700">
                    Sair
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex flex-wrap gap-2 mb-6 border-b border-zinc-800">
            <button id="tabUpload" onclick="switchTab('upload')"
                class="focusable px-4 py-2 border-b-2 border-yellow-500 text-yellow-500 font-medium">
                Upload APK
            </button>
            <button id="tabManage" onclick="switchTab('manage')"
                class="focusable px-4 py-2 border-b-2 border-transparent text-zinc-400 hover:text-zinc-50">
                Gerenciar
            </button>
            <button id="tabStats" onclick="switchTab('stats')"
                class="focusable px-4 py-2 border-b-2 border-transparent text-zinc-400 hover:text-zinc-50">
                📊 Estatísticas
            </button>
            <button id="tabSetup" onclick="switchTab('setup')"
                class="focusable px-4 py-2 border-b-2 border-transparent text-zinc-400 hover:text-zinc-50">
                Setup
            </button>
        </div>

        <!-- Upload Tab -->
        <div id="uploadTab" class="bg-zinc-900 border border-zinc-800 rounded-md p-6">
            <h3 class="text-xl font-semibold mb-4 text-zinc-50">Upload de APK</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Nome do App (opcional - detecta do arquivo)</label>
                    <input type="text" id="appName"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Ex: Meu Aplicativo">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Versão do Sistema (opcional -
                        auto-incrementa)</label>
                    <input type="text" id="appVersion"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Ex: 1.0, 1.1, 1.2...">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Versão do Android (opcional)</label>
                    <input type="text" id="appVersionAndroid"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Ex: 2.5.1, 3.0.0">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Data da Versão (opcional)</label>
                        <input type="date" id="appVersionDate"
                            class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50">
                    </div>
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Data do Upload (hoje por padrão)</label>
                        <input type="date" id="appUploadDate"
                            class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Descrição</label>
                    <textarea id="appDescription" rows="3"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Descrição do aplicativo..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">O que há de novo (changelog)</label>
                    <textarea id="appChangelog" rows="2"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Ex: - Correção de bugs&#10;- Nova funcionalidade X..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Categoria (opcional)</label>
                    <input type="text" id="appCategory"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Ex: Produtividade, Jogos, Ferramentas">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Ícone do App (PNG/JPG)</label>
                    <input type="file" id="iconFile" accept="image/png,image/jpeg,image/jpg"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-blue-600 file:text-zinc-50 file:font-medium hover:file:bg-blue-500">
                    <p class="text-xs text-zinc-500 mt-1">Recomendado: 512x512px, PNG transparente</p>
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Arquivo APK</label>
                    <input type="file" id="apkFile" accept=".apk" onchange="handleAPKSelection(this)"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-yellow-500 file:text-zinc-950 file:font-medium hover:file:bg-yellow-400">
                    <p id="apkAutoInfo" class="text-xs text-blue-400 mt-1 hidden"></p>
                    <input type="hidden" id="appPackageName">
                </div>
                <button onclick="uploadAPK()" id="uploadBtn"
                    class="focusable w-full px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                    Upload para GitHub Releases
                </button>
            </div>
            <div id="uploadStatus" class="hidden mt-4"></div>
        </div>

        <!-- Manage Tab -->
        <div id="manageTab" class="hidden bg-zinc-900 border border-zinc-800 rounded-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-zinc-50">Gerenciar Aplicativos</h3>
                <button onclick="loadManageApps()"
                    class="focusable px-3 py-1 bg-blue-600 hover:bg-blue-500 text-zinc-50 text-sm rounded-md">
                    🔄 Atualizar
                </button>
            </div>
            <div class="mb-4">
                <label class="inline-flex items-center text-sm text-zinc-400">
                    <input type="checkbox" id="showInactive" onchange="loadManageApps()" class="mr-2 rounded">
                    Mostrar apps inativos
                </label>
            </div>
            <div id="manageAppsList" class="space-y-2">
                <p class="text-zinc-500 text-center py-8">Clique em "Atualizar" para carregar a lista de apps.</p>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="statsTab" class="hidden bg-zinc-900 border border-zinc-800 rounded-md p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-zinc-50">📊 Estatísticas da Loja</h3>
                <button onclick="loadStats()"
                    class="focusable px-3 py-1 bg-blue-600 hover:bg-blue-500 text-zinc-50 text-sm rounded-md">
                    🔄 Atualizar
                </button>
            </div>

            <!-- Metrics Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-zinc-950 border border-zinc-800 rounded-md p-4 text-center">
                    <p class="text-3xl font-bold text-yellow-500" id="statTotalApps">-</p>
                    <p class="text-sm text-zinc-400">Apps Ativos</p>
                </div>
                <div class="bg-zinc-950 border border-zinc-800 rounded-md p-4 text-center">
                    <p class="text-3xl font-bold text-blue-500" id="statTotalDownloads">-</p>
                    <p class="text-sm text-zinc-400">Downloads</p>
                </div>
                <div class="bg-zinc-950 border border-zinc-800 rounded-md p-4 text-center">
                    <p class="text-3xl font-bold text-green-500" id="statPositiveRatings">-</p>
                    <p class="text-sm text-zinc-400">👍 Positivos</p>
                </div>
                <div class="bg-zinc-950 border border-zinc-800 rounded-md p-4 text-center">
                    <p class="text-3xl font-bold text-red-500" id="statNegativeRatings">-</p>
                    <p class="text-sm text-zinc-400">👎 Negativos</p>
                </div>
            </div>

            <!-- Top Apps -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-zinc-50 mb-3">🏆 Top Apps por Downloads</h4>
                <div id="topAppsList" class="space-y-2">
                    <p class="text-zinc-500 text-center py-4">Carregando...</p>
                </div>
            </div>

            <!-- Storage Monitoring -->
            <div class="mb-6 border-t border-zinc-800 pt-6">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-semibold text-zinc-50">💾 Uso de Armazenamento</h4>
                    <button onclick="loadStorageStats()"
                        class="focusable px-2 py-1 text-xs bg-zinc-700 hover:bg-zinc-600 text-zinc-50 rounded">
                        🔄 Atualizar
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <!-- Supabase Storage -->
                    <div class="bg-zinc-950 border border-zinc-800 rounded-md p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-green-500">🗄️</span>
                            <span class="font-medium text-zinc-50">Supabase Storage</span>
                        </div>
                        <p class="text-2xl font-bold text-green-400" id="supabaseStorageUsed">-</p>
                        <p class="text-xs text-zinc-500">Espaço usado (ícones)</p>
                        <div class="mt-2 bg-zinc-800 h-2 rounded-full overflow-hidden">
                            <div id="supabaseStorageBar" class="bg-green-500 h-full transition-all" style="width: 0%">
                            </div>
                        </div>
                        <p class="text-xs text-zinc-600 mt-1">Limite: 1 GB (plano gratuito)</p>
                    </div>

                    <!-- GitHub Releases -->
                    <div class="bg-zinc-950 border border-zinc-800 rounded-md p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-purple-500">📦</span>
                            <span class="font-medium text-zinc-50">GitHub Releases</span>
                        </div>
                        <p class="text-2xl font-bold text-purple-400" id="githubReleasesCount">-</p>
                        <p class="text-xs text-zinc-500">APKs hospedados</p>
                        <p class="text-xl font-semibold text-blue-400 mt-2" id="githubTotalDownloads">-</p>
                        <p class="text-xs text-zinc-500">Downloads totais (GitHub)</p>
                    </div>
                </div>

                <!-- Explanation -->
                <div class="bg-zinc-950 border border-zinc-700 rounded-md p-3 text-xs">
                    <p class="text-yellow-500 font-medium mb-1">⚠️ Limitações da API:</p>
                    <ul class="text-zinc-400 space-y-1 list-disc list-inside">
                        <li><strong>Supabase:</strong> Mostra apenas ícones no bucket app-icons. Tráfego/bandwidth não
                            disponível via API.</li>
                        <li><strong>GitHub:</strong> Downloads contados por release. Sem limite de storage para releases
                            públicas.</li>
                        <li>Para dados completos de uso, acesse os dashboards oficiais.</li>
                    </ul>
                </div>
            </div>

            <!-- Export Section -->
            <div class="border-t border-zinc-800 pt-6">
                <h4 class="text-lg font-semibold text-zinc-50 mb-3">📦 Exportar Dados</h4>
                <div class="flex flex-wrap gap-3">
                    <button onclick="exportData('json')"
                        class="focusable px-4 py-2 bg-green-600 hover:bg-green-500 text-zinc-50 rounded-md">
                        📄 Exportar JSON
                    </button>
                    <button onclick="exportData('csv')"
                        class="focusable px-4 py-2 bg-purple-600 hover:bg-purple-500 text-zinc-50 rounded-md">
                        📊 Exportar CSV
                    </button>
                    <button onclick="exportRatings()"
                        class="focusable px-4 py-2 bg-orange-600 hover:bg-orange-500 text-zinc-50 rounded-md">
                        ⭐ Exportar Avaliações
                    </button>
                </div>
                <p class="text-xs text-zinc-500 mt-2">Os arquivos serão baixados automaticamente.</p>
            </div>
        </div>

        <!-- Setup Tab -->
        <div id="setupTab" class="hidden bg-zinc-900 border border-zinc-800 rounded-md p-6">
            <h3 class="text-xl font-semibold mb-4 text-zinc-50">Configurações</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Supabase URL</label>
                    <input type="text" id="supabaseUrl"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="https://xxx.supabase.co">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Supabase Anon Key</label>
                    <input type="password" id="supabaseKey"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="eyJ...">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">GitHub Token</label>
                    <input type="password" id="githubToken"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="ghp_...">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">GitHub Repo Path</label>
                    <input type="text" id="githubRepo"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="usuario/repositorio">
                </div>
                <button onclick="saveSetup()"
                    class="focusable w-full px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                    Salvar Configurações
                </button>
                <button onclick="testGitHubConnection()"
                    class="focusable w-full px-4 py-3 bg-blue-600 hover:bg-blue-500 text-zinc-50 font-medium rounded-md">
                    🔍 Testar Conexão GitHub
                </button>
            </div>
            <div id="setupStatus" class="hidden mt-4"></div>
        </div>
    </div>

    <!-- Setup Modal (Initial Configuration) -->
    <div id="setupModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div
            class="bg-zinc-900 border border-zinc-800 rounded-md p-6 max-w-2xl mx-4 w-full max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-zinc-50">Configuração Inicial</h3>
                <button onclick="closeSetupModal()"
                    class="focusable text-zinc-400 hover:text-zinc-50 text-2xl">&times;</button>
            </div>
            <p class="text-sm text-zinc-400 mb-6">Configure suas credenciais do Supabase e GitHub para usar a loja de
                APKs.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Supabase URL</label>
                    <input type="text" id="setupModalSupabaseUrl"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="https://xxx.supabase.co">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Supabase Anon Key</label>
                    <input type="password" id="setupModalSupabaseKey"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="eyJ...">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">GitHub Token (opcional, para upload)</label>
                    <input type="password" id="setupModalGithubToken"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="ghp_...">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">GitHub Repo Path (opcional, para upload)</label>
                    <input type="text" id="setupModalGithubRepo"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="usuario/repositorio">
                </div>
                <button onclick="saveSetupFromModal()"
                    class="focusable w-full px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                    Salvar e Fechar
                </button>
            </div>
            <div id="setupModalStatus" class="hidden mt-4"></div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-zinc-900 border border-zinc-800 rounded-md p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-zinc-50">Como Instalar APKs</h3>
                <button onclick="closeHelpModal()"
                    class="focusable text-zinc-400 hover:text-zinc-50 text-2xl">&times;</button>
            </div>
            <div class="space-y-4 text-zinc-300">
                <div class="flex items-start gap-3">
                    <div
                        class="flex-shrink-0 w-8 h-8 bg-yellow-500 text-zinc-950 rounded-full flex items-center justify-center font-bold">
                        1</div>
                    <div>
                        <h4 class="font-semibold text-zinc-50 mb-1">Habilitar Fontes Desconhecidas</h4>
                        <p class="text-sm">Vá em <strong>Configurações → Segurança</strong> e ative a opção
                            <strong>"Fontes desconhecidas"</strong> ou <strong>"Instalar apps desconhecidos"</strong>.
                        </p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div
                        class="flex-shrink-0 w-8 h-8 bg-yellow-500 text-zinc-950 rounded-full flex items-center justify-center font-bold">
                        2</div>
                    <div>
                        <h4 class="font-semibold text-zinc-50 mb-1">Baixar o APK</h4>
                        <p class="text-sm">Clique no aplicativo desejado e toque em <strong>"Download"</strong>. O
                            arquivo será salvo na pasta Downloads.</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div
                        class="flex-shrink-0 w-8 h-8 bg-yellow-500 text-zinc-950 rounded-full flex items-center justify-center font-bold">
                        3</div>
                    <div>
                        <h4 class="font-semibold text-zinc-50 mb-1">Instalar o APK</h4>
                        <p class="text-sm">Abra o gerenciador de arquivos, vá até <strong>Downloads</strong>, toque no
                            arquivo APK e siga as instruções na tela.</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div
                        class="flex-shrink-0 w-8 h-8 bg-yellow-500 text-zinc-950 rounded-full flex items-center justify-center font-bold">
                        4</div>
                    <div>
                        <h4 class="font-semibold text-zinc-50 mb-1">Abrir o App</h4>
                        <p class="text-sm">Após a instalação, o ícone aparecerá na lista de aplicativos. Toque para
                            abrir!</p>
                    </div>
                </div>
            </div>
            <button onclick="closeHelpModal()"
                class="focusable mt-6 w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                Entendi
            </button>
        </div>
    </div>

    <!-- Edit App Modal -->
    <div id="editAppModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div
            class="bg-zinc-900 border border-zinc-800 rounded-md p-6 max-w-2xl mx-4 w-full max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-zinc-50">Editar Aplicativo</h3>
                <button onclick="closeEditModal()"
                    class="focusable text-zinc-400 hover:text-zinc-50 text-2xl">&times;</button>
            </div>
            <input type="hidden" id="editAppId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Nome do App</label>
                    <input type="text" id="editAppName"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Versão do Sistema</label>
                        <input type="text" id="editAppVersion"
                            class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50">
                    </div>
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Versão do Android</label>
                        <input type="text" id="editAppVersionAndroid"
                            class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Data da Versão</label>
                        <input type="date" id="editAppVersionDate"
                            class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50">
                    </div>
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Data do Upload</label>
                        <input type="date" id="editAppUploadDate"
                            class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Descrição</label>
                    <textarea id="editAppDescription" rows="3"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"></textarea>
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">O que há de novo (changelog)</label>
                    <textarea id="editAppChangelog" rows="2"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"></textarea>
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Categoria</label>
                    <input type="text" id="editAppCategory"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50">
                </div>
                <button onclick="saveAppEdit()"
                    class="focusable w-full px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                    💾 Salvar Alterações
                </button>
            </div>
            <div id="editAppStatus" class="hidden mt-4"></div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteAppModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-zinc-900 border border-zinc-800 rounded-md p-6 max-w-md mx-4 w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-zinc-50">⚠️ Confirmar Ação</h3>
                <button onclick="closeDeleteModal()"
                    class="focusable text-zinc-400 hover:text-zinc-50 text-2xl">&times;</button>
            </div>
            <input type="hidden" id="deleteAppId">
            <p id="deleteAppName" class="text-zinc-300 mb-4"></p>
            <div class="space-y-3">
                <button onclick="toggleAppStatus(false)"
                    class="focusable w-full px-4 py-3 bg-orange-600 hover:bg-orange-500 text-zinc-50 font-medium rounded-md">
                    🔒 Desativar (ocultar da loja)
                </button>
                <button onclick="deleteAppPermanently()"
                    class="focusable w-full px-4 py-3 bg-red-600 hover:bg-red-500 text-zinc-50 font-medium rounded-md">
                    🗑️ Excluir Permanentemente
                </button>
                <button onclick="closeDeleteModal()"
                    class="focusable w-full px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-50 rounded-md border border-zinc-700">
                    Cancelar
                </button>
            </div>
            <div id="deleteAppStatus" class="hidden mt-4"></div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="ratingModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-zinc-900 border border-zinc-800 rounded-md p-6 max-w-md mx-4 w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-zinc-50">Avaliar Aplicativo</h3>
                <button onclick="closeRatingModal()"
                    class="focusable text-zinc-400 hover:text-zinc-50 text-2xl">&times;</button>
            </div>
            <input type="hidden" id="ratingAppId">
            <p id="ratingAppName" class="text-zinc-300 mb-4 text-center font-semibold"></p>

            <div id="ratingStep1">
                <p class="text-zinc-400 mb-4 text-center">Você testou este aplicativo no seu dispositivo?</p>
                <div class="flex gap-3">
                    <button onclick="confirmTested(true)"
                        class="focusable flex-1 px-4 py-3 bg-green-600 hover:bg-green-500 text-zinc-50 font-medium rounded-md">
                        ✅ Sim, testei
                    </button>
                    <button onclick="confirmTested(false)"
                        class="focusable flex-1 px-4 py-3 bg-zinc-700 hover:bg-zinc-600 text-zinc-50 font-medium rounded-md">
                        ❌ Não testei
                    </button>
                </div>
            </div>

            <div id="ratingStep2" class="hidden">
                <p class="text-zinc-400 mb-4 text-center">O aplicativo funcionou corretamente?</p>
                <div class="flex gap-3">
                    <button onclick="submitRating(true)"
                        class="focusable flex-1 px-4 py-4 bg-green-600 hover:bg-green-500 text-zinc-50 font-medium rounded-md text-2xl">
                        👍 Funciona
                    </button>
                    <button onclick="submitRating(false)"
                        class="focusable flex-1 px-4 py-4 bg-red-600 hover:bg-red-500 text-zinc-50 font-medium rounded-md text-2xl">
                        👎 Não funciona
                    </button>
                </div>
            </div>

            <div id="ratingNotTested" class="hidden text-center">
                <p class="text-zinc-400 mb-4">Por favor, teste o aplicativo antes de avaliar.</p>
                <button onclick="closeRatingModal()"
                    class="focusable px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-50 rounded-md border border-zinc-700">
                    Entendi
                </button>
            </div>

            <div id="ratingStatus" class="hidden mt-4"></div>
        </div>
    </div>

    <!-- App Details Modal -->
    <div id="appDetailsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div
            class="bg-zinc-900 border border-zinc-800 rounded-md p-6 max-w-2xl mx-4 w-full max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 id="detailsAppName" class="text-xl font-bold text-zinc-50"></h3>
                <button onclick="closeDetailsModal()"
                    class="focusable text-zinc-400 hover:text-zinc-50 text-2xl">&times;</button>
            </div>
            <input type="hidden" id="detailsAppId">

            <div class="flex items-start gap-4 mb-4">
                <div id="detailsAppIcon" class="w-20 h-20 rounded-md overflow-hidden"></div>
                <div class="flex-1">
                    <div class="flex flex-wrap gap-2 mb-2">
                        <span id="detailsAppCategory"
                            class="px-2 py-1 text-xs bg-zinc-800 text-zinc-300 rounded"></span>
                        <span id="detailsAppSize" class="px-2 py-1 text-xs bg-zinc-800 text-zinc-300 rounded"></span>
                    </div>
                    <p id="detailsAppVersion" class="text-sm text-zinc-400"></p>
                    <p id="detailsAppVersionAndroid" class="text-sm text-zinc-500"></p>
                    <p id="detailsAppDate" class="text-sm text-zinc-500"></p>
                    <p id="detailsUploadDate" class="text-sm text-zinc-600 font-medium"></p>
                </div>
            </div>

            <div class="mb-4">
                <h4 class="text-sm font-semibold text-zinc-300 mb-2">Descrição</h4>
                <p id="detailsAppDescription" class="text-sm text-zinc-400"></p>
            </div>

            <div id="detailsChangelogSection" class="hidden mb-4">
                <h4 class="text-sm font-semibold text-zinc-300 mb-2">O que há de novo</h4>
                <div id="detailsAppChangelog"
                    class="text-sm text-zinc-400 bg-zinc-950 p-3 rounded-md whitespace-pre-wrap"></div>
            </div>

            <div class="flex items-center gap-4 mb-4 p-3 bg-zinc-950 rounded-md">
                <div class="flex items-center gap-2">
                    <span class="text-green-400">👍</span>
                    <span id="detailsPositive" class="text-zinc-300">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-red-400">👎</span>
                    <span id="detailsNegative" class="text-zinc-300">0</span>
                </div>
                <div class="flex items-center gap-2 ml-auto">
                    <span class="text-blue-400">📥</span>
                    <span id="detailsDownloads" class="text-zinc-300">0 downloads</span>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="rateFromDetails(true)"
                    class="focusable flex-1 px-4 py-2 bg-green-600 hover:bg-green-500 text-zinc-50 rounded-md">
                    👍 Funciona
                </button>
                <button onclick="rateFromDetails(false)"
                    class="focusable flex-1 px-4 py-2 bg-red-600 hover:bg-red-500 text-zinc-50 rounded-md">
                    👎 Não funciona
                </button>
            </div>

            <a id="detailsDownloadBtn" href="#" download onclick="trackDownload()"
                class="focusable block w-full px-4 py-3 mt-4 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md text-center">
                📥 Download APK (Versão Atual)
            </a>

            <!-- Version History -->
            <div id="versionHistorySection" class="hidden mt-4 border-t border-zinc-800 pt-4">
                <h4 class="text-sm font-semibold text-zinc-300 mb-3">📜 Versões Anteriores</h4>
                <div id="versionHistoryList" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        var supabaseClient = null;
        var allApps = [];
        var currentView = 'store';

        // Initialize app on load
        window.addEventListener('load', function () {
            initApp();
        });

        // Initialize application
        function initApp() {
            // IMPORTANTE: loadSetup deve ser chamado PRIMEIRO para inicializar o supabaseClient
            // antes que setupRouter chame handleRoute() -> renderStore()
            loadSetup();
            setupRouter();
            setupKeyboardNav();
        }

        // Setup hash-based routing
        // --- IDEIA 2: AUTO-PARSING APK (Robusto) --- ES5 para TV Box
        function handleAPKSelection(input) {
            var file = input.files[0];
            if (!file) return;

            var statusEl = document.getElementById('apkAutoInfo');
            statusEl.classList.remove('hidden');
            statusEl.textContent = '🔄 Analisando estrutura do APK...';
            statusEl.className = 'text-xs text-blue-400 mt-1';

            var zip = new JSZip();
            zip.loadAsync(file).then(function (loadedZip) {
                var manifestFile = loadedZip.file("AndroidManifest.xml");
                if (!manifestFile) throw new Error('Manifest não encontrado');

                return manifestFile.async("uint8array");
            }).then(function (buffer) {
                // Decodificador AXML Simplificado (Extração de String Pool)
                // O AndroidManifest binário guarda todas as strings em um "Pool" no início do arquivo
                var view = new DataView(buffer.buffer, buffer.byteOffset, buffer.byteLength);

                // Header: Magic Number (0x00080003) e Size
                if (view.getUint32(0, true) !== 0x00080003) throw new Error('Não é um AXML válido');

                // String Pool Header (geralmente começa no offset 8)
                var stringPoolOffset = 8;
                var chunkType = view.getUint32(stringPoolOffset, true);
                if (chunkType !== 0x001C0001) throw new Error('String pool não encontrado');

                var stringCount = view.getUint32(stringPoolOffset + 8, true);
                var stringsOffset = stringPoolOffset + view.getUint32(stringPoolOffset + 20, true);

                var strings = [];
                for (var i = 0; i < stringCount; i++) {
                    var off = stringsOffset + view.getUint32(stringPoolOffset + 28 + (i * 4), true);
                    var len = view.getUint16(off, true); // UTF-16 len
                    var str = "";
                    for (var j = 0; j < len; j++) {
                        str += String.fromCharCode(view.getUint16(off + 2 + (j * 2), true));
                    }
                    strings.push(str);
                }

                // Agora procuramos na lista de strings por algo que pareça um package name ou versão
                var pkg = null;
                var ver = null;
                for (var k = 0; k < strings.length; k++) {
                    var s = strings[k];
                    if (!pkg && s.indexOf('.') !== -1 && s.split('.').length >= 2 && s.indexOf(' ') === -1 && s.length > 5) {
                        pkg = s;
                    }
                    if (!ver && /^[0-9]+\.[0-9]+/.test(s)) {
                        ver = s;
                    }
                }

                var infoParts = [];
                if (pkg) {
                    document.getElementById('appPackageName').value = pkg;
                    infoParts.push('📦 ID: ' + pkg);
                }
                if (ver) {
                    document.getElementById('appVersionAndroid').value = ver;
                    infoParts.push('ver: ' + ver);
                }

                // Nome do App sugerido pelo arquivo (sempre substitui ao trocar de arquivo)
                var cleanName = file.name.replace('.apk', '').replace(/[_-]/g, ' ');
                document.getElementById('appName').value = cleanName.charAt(0).toUpperCase() + cleanName.slice(1);

                if (infoParts.length > 0) {
                    statusEl.textContent = '✅ Detectado: ' + infoParts.join(' • ');
                    statusEl.className = 'text-xs text-green-400 mt-1';
                } else {
                    statusEl.textContent = '⚠️ Dados parciais ou não encontrados no pool de strings.';
                    statusEl.className = 'text-xs text-yellow-500 mt-1';
                }

            }).catch(function (err) {
                console.error('Erro ao ler APK:', err);
                statusEl.textContent = '⚠️ Incompatibilidade: Este APK usa uma estrutura de strings diferente.';
                statusEl.className = 'text-xs text-zinc-500 mt-1';
            });
        }
        // ---------------------------------

        function setupRouter() {
            window.addEventListener('hashchange', handleRoute);
            handleRoute();
        }

        function handleRoute() {
            var hash = window.location.hash;

            // Hide all views
            document.getElementById('storeView').classList.add('hidden');
            document.getElementById('adminLoginView').classList.add('hidden');
            document.getElementById('adminDashboardView').classList.add('hidden');

            // Show appropriate view
            if (hash === '' || hash === '#/') {
                document.getElementById('storeView').classList.remove('hidden');
                currentView = 'store';
                renderStore();
            } else if (hash === '#/admin') {
                document.getElementById('adminLoginView').classList.remove('hidden');
                currentView = 'adminLogin';
            } else if (hash === '#/admin/dashboard') {
                var isAuthenticated = localStorage.getItem('adminAuth') === 'true';
                if (isAuthenticated) {
                    document.getElementById('adminDashboardView').classList.remove('hidden');
                    currentView = 'adminDashboard';
                    loadSetupValues();
                } else {
                    navigateTo('#/admin');
                }
            } else {
                navigateTo('#/');
            }
        }

        // Navigate to route
        function navigateTo(route) {
            window.location.hash = route;
        }

        // Load setup from localStorage
        // Initialize Supabase client
        function loadSetup() {
            // Default configuration (Hardcoded for single-file deployment)
            var defaultConfig = {
                url: 'https://zrxowkbepbfmqnqlneid.supabase.co',
                key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyeG93a2JlcGJmbXFucWxuZWlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1ODkwMDksImV4cCI6MjA4MjE2NTAwOX0.0GJMzS9bxzqNJJrz-dSzDslr01C7ubSPVbvB71_ZLMI'
            };

            var supabaseUrl = defaultConfig.url;
            var supabaseKey = defaultConfig.key;

            // Salvar no localStorage para compatibilidade
            localStorage.setItem('supabaseUrl', supabaseUrl);
            localStorage.setItem('supabaseKey', supabaseKey);

            // Tentar usar a biblioteca oficial do Supabase
            if (typeof supabase !== 'undefined' && supabase && supabase.createClient) {
                try {
                    supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('Supabase conectado via biblioteca oficial!');
                    return;
                } catch (error) {
                    console.warn('Erro na biblioteca Supabase, usando fallback REST:', error);
                }
            }

            // FALLBACK: Criar cliente REST simples para TV Boxes antigas
            console.log('Usando cliente REST fallback para compatibilidade...');
            supabaseClient = createRestClient(supabaseUrl, supabaseKey);
        }

        // Cliente REST simples (ES5) para browsers antigos
        function createRestClient(baseUrl, apiKey) {
            return {
                from: function (table) {
                    return new RestQueryBuilder(baseUrl, apiKey, table);
                },
                storage: {
                    from: function (bucket) {
                        return {
                            list: function () {
                                return Promise.resolve({ data: [], error: null });
                            }
                        };
                    }
                },
                rpc: function (fname, params) {
                    var url = baseUrl + '/rest/v1/rpc/' + fname;
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'apikey': apiKey,
                            'Authorization': 'Bearer ' + apiKey,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(params)
                    }).then(function (res) {
                        return res.json().then(function (data) {
                            return { data: data, error: res.ok ? null : data };
                        });
                    }).catch(function (err) {
                        return { data: null, error: err };
                    });
                }
            };
        }

        // Query Builder REST (ES5)
        function RestQueryBuilder(baseUrl, apiKey, table) {
            this.baseUrl = baseUrl;
            this.apiKey = apiKey;
            this.table = table;
            this.params = [];
            this.selectFields = '*';
            this.orderBy = null;
        }

        RestQueryBuilder.prototype.select = function (fields) {
            this.selectFields = fields || '*';
            return this;
        };

        RestQueryBuilder.prototype.eq = function (column, value) {
            this.params.push(column + '=eq.' + encodeURIComponent(value));
            return this;
        };

        RestQueryBuilder.prototype.neq = function (column, value) {
            this.params.push(column + '=neq.' + encodeURIComponent(value));
            return this;
        };

        RestQueryBuilder.prototype.in = function (column, values) {
            this.params.push(column + '=in.(' + values.map(function (v) { return encodeURIComponent(v); }).join(',') + ')');
            return this;
        };

        RestQueryBuilder.prototype.order = function (column, options) {
            var dir = (options && options.ascending === false) ? 'desc' : 'asc';
            this.orderBy = 'order=' + column + '.' + dir;
            return this;
        };

        RestQueryBuilder.prototype.limit = function (n) {
            this.params.push('limit=' + n);
            return this;
        };

        RestQueryBuilder.prototype.single = function () {
            this.params.push('limit=1');
            this.isSingle = true;
            return this;
        };

        RestQueryBuilder.prototype.then = function (callback) {
            var url = this.baseUrl + '/rest/v1/' + this.table + '?select=' + encodeURIComponent(this.selectFields);
            if (this.params.length > 0) {
                url += '&' + this.params.join('&');
            }
            if (this.orderBy) {
                url += '&' + this.orderBy;
            }

            var self = this;
            return fetch(url, {
                method: 'GET',
                headers: {
                    'apikey': this.apiKey,
                    'Authorization': 'Bearer ' + this.apiKey,
                    'Content-Type': 'application/json'
                }
            }).then(function (res) {
                return res.json().then(function (data) {
                    if (self.isSingle && Array.isArray(data)) {
                        data = data[0] || null;
                    }
                    return { data: data, error: res.ok ? null : data };
                });
            }).then(callback).catch(function (err) {
                return callback({ data: null, error: err });
            });
        };

        RestQueryBuilder.prototype.catch = function (callback) {
            // Handled in then
            return this;
        };


        // Render store view
        function renderStore() {
            if (!supabaseClient) {
                showEmptyState('Configure o Supabase no painel Admin primeiro.');
                return;
            }

            document.getElementById('storeLoading').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');

            supabaseClient
                .from('aplicativos')
                .select('*')
                .neq('ativo', false)
                .order('data_upload', { ascending: false })
                .then(function (response) {
                    document.getElementById('storeLoading').classList.add('hidden');

                    if (response.error) {
                        console.error('Erro ao carregar apps:', response.error);
                        showEmptyState('Erro ao carregar aplicativos.');
                        return;
                    }

                    allApps = response.data || [];
                    loadRatingsAndDisplay(allApps);
                })
                .catch(function (error) {
                    console.error('Erro:', error);
                    document.getElementById('storeLoading').classList.add('hidden');
                    showEmptyState('Erro ao conectar com o servidor.');
                });
        }

        // Load ratings for apps and then display
        function loadRatingsAndDisplay(apps) {
            if (!apps || apps.length === 0) {
                displayApps(apps, {});
                return;
            }

            var appIds = [];
            for (var i = 0; i < apps.length; i++) {
                appIds.push(apps[i].id);
            }

            supabaseClient
                .from('avaliacoes')
                .select('aplicativo_id, positivo')
                .in('aplicativo_id', appIds)
                .then(function (response) {
                    var ratings = {};
                    if (response.data) {
                        for (var i = 0; i < response.data.length; i++) {
                            var r = response.data[i];
                            if (!ratings[r.aplicativo_id]) {
                                ratings[r.aplicativo_id] = { positivo: 0, negativo: 0 };
                            }
                            if (r.positivo) {
                                ratings[r.aplicativo_id].positivo++;
                            } else {
                                ratings[r.aplicativo_id].negativo++;
                            }
                        }
                    }
                    allRatings = ratings;
                    populateCategories(apps);
                    filterApps();
                })
                .catch(function () {
                    allRatings = {};
                    populateCategories(apps);
                    filterApps();
                });
        }

        // Display apps in grid
        function displayApps(apps, ratings) {
            var appList = document.getElementById('appList');
            ratings = ratings || {};

            if (!apps || apps.length === 0) {
                appList.innerHTML = '';
                showEmptyState('Nenhum aplicativo disponível.');
                return;
            }

            document.getElementById('emptyState').classList.add('hidden');

            var html = '';
            var now = new Date();
            var sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            for (var i = 0; i < apps.length; i++) {
                var app = apps[i];
                var iconHtml = generateProgressiveIcon(app.nome, app.icone_url);

                var sizeText = app.tamanho_mb ? app.tamanho_mb + ' MB' : 'N/A';
                var versionText = app.versao ? 'v' + app.versao : '';
                if (app.versao_android) versionText += ' (Android: ' + app.versao_android + ')';
                if (!versionText) versionText = 'Sem versão';
                var description = app.descricao || 'Sem descrição';
                var category = app.categoria ? '<span class="inline-block px-2 py-1 text-xs bg-zinc-800 text-zinc-300 rounded">' + app.categoria + '</span>' : '';

                // Check if app is new (less than 7 days old)
                var isNew = app.data_upload && new Date(app.data_upload) > sevenDaysAgo;
                var newBadge = isNew ? '<span class="ml-2 px-2 py-0.5 text-xs bg-green-600 text-white rounded-full animate-pulse">NOVO</span>' : '';

                // Dates
                var versionDate = app.data_versao ? new Date(app.data_versao).toLocaleDateString('pt-BR') : 'Não informada';
                var uploadDate = app.data_upload ? new Date(app.data_upload).toLocaleDateString('pt-BR') : 'Não informada';

                var appRating = ratings[app.id] || { positivo: 0, negativo: 0 };
                var ratingHtml = '<div class="flex items-center gap-3 text-sm">';
                ratingHtml += '<span class="text-green-400">👍 ' + appRating.positivo + '</span>';
                ratingHtml += '<span class="text-red-400">👎 ' + appRating.negativo + '</span>';
                if (uploadDate) ratingHtml += '<span class="text-zinc-600 text-xs">' + uploadDate + '</span>';
                ratingHtml += '<span class="text-blue-400 ml-2" title="Downloads">📥 ' + (app.downloads || 0) + '</span>';
                ratingHtml += '<button onclick="openDetailsModal(\'' + app.id + '\')" class="focusable ml-auto px-2 py-1 text-xs bg-blue-600 hover:bg-blue-500 text-zinc-50 rounded">Ver mais</button>';
                ratingHtml += '</div>';

                html += '<div class="bg-zinc-900 border border-zinc-800 rounded-md p-4 hover:border-zinc-700 transition-colors">';
                html += '  <div class="flex items-start gap-4 mb-3">';
                html += '    ' + iconHtml;
                html += '    <div class="flex-1 min-w-0">';
                html += '      <h3 class="text-lg font-semibold text-zinc-50 truncate">' + app.nome + newBadge + '</h3>';
                html += '      <p class="text-sm text-zinc-400">' + versionText + '</p>';
                html += '      <p class="text-sm text-zinc-500">' + sizeText + '</p>';
                if (category) html += '      <div class="mt-1">' + category + '</div>';
                html += '    </div>';
                html += '  </div>';
                html += '  <p class="text-sm text-zinc-400 mb-3 line-clamp-2">' + description + '</p>';
                html += '  ' + ratingHtml;
                html += '  <a href="' + app.apk_url + '" download onclick="trackDownloadFromHome(\'' + app.id + '\')" class="focusable block w-full px-4 py-2 mt-3 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md text-center text-sm">';
                html += '    Download';
                html += '  </a>';
                html += '</div>';
            }

            appList.innerHTML = html;
        }
        // Global ratings cache for sorting
        var allRatings = {};

        // Filter and sort apps
        function filterApps() {
            var searchTerm = document.getElementById('searchInput').value.toLowerCase();
            var categoryFilter = document.getElementById('categoryFilter').value;
            var sortOrder = document.getElementById('sortOrder').value;

            var filtered = [];
            for (var i = 0; i < allApps.length; i++) {
                var app = allApps[i];

                // Search filter
                var matchSearch = !searchTerm ||
                    app.nome.toLowerCase().indexOf(searchTerm) !== -1 ||
                    (app.descricao && app.descricao.toLowerCase().indexOf(searchTerm) !== -1) ||
                    (app.categoria && app.categoria.toLowerCase().indexOf(searchTerm) !== -1);

                // Category filter
                var matchCategory = !categoryFilter || app.categoria === categoryFilter;

                if (matchSearch && matchCategory) {
                    filtered.push(app);
                }
            }

            // Sort
            filtered.sort(function (a, b) {
                if (sortOrder === 'name_asc') {
                    return a.nome.localeCompare(b.nome);
                } else if (sortOrder === 'name_desc') {
                    return b.nome.localeCompare(a.nome);
                } else if (sortOrder === 'rating') {
                    var ratingA = allRatings[a.id] ? (allRatings[a.id].positivo - allRatings[a.id].negativo) : 0;
                    var ratingB = allRatings[b.id] ? (allRatings[b.id].positivo - allRatings[b.id].negativo) : 0;
                    return ratingB - ratingA;
                } else { // recent
                    var dateA = a.data_upload ? new Date(a.data_upload) : new Date(0);
                    var dateB = b.data_upload ? new Date(b.data_upload) : new Date(0);
                    return dateB - dateA;
                }
            });

            // Update count
            document.getElementById('appCount').textContent = filtered.length + ' app' + (filtered.length !== 1 ? 's' : '');

            displayApps(filtered, allRatings);
        }

        // Populate category dropdown
        function populateCategories(apps) {
            var categories = {};
            for (var i = 0; i < apps.length; i++) {
                if (apps[i].categoria) {
                    categories[apps[i].categoria] = true;
                }
            }

            var select = document.getElementById('categoryFilter');
            var currentValue = select.value;
            select.innerHTML = '<option value="">Todas as categorias</option>';

            var sortedCategories = Object.keys(categories).sort();
            for (var j = 0; j < sortedCategories.length; j++) {
                var option = document.createElement('option');
                option.value = sortedCategories[j];
                option.textContent = sortedCategories[j];
                select.appendChild(option);
            }

            select.value = currentValue;
        }

        // Generate fallback icon (circle with initial)
        function generateFallbackIcon(name) {
            var initial = name.charAt(0).toUpperCase();
            var colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];
            var colorIndex = name.charCodeAt(0) % colors.length;
            var color = colors[colorIndex];

            var svg = '<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">';
            svg += '<circle cx="32" cy="32" r="32" fill="' + color + '"/>';
            svg += '<text x="32" y="42" text-anchor="middle" fill="white" font-size="28" font-weight="bold" font-family="system-ui">' + initial + '</text>';
            svg += '</svg>';

            return '<div class="w-16 h-16 rounded-md overflow-hidden">' + svg + '</div>';
        }

        // Generate progressive icon with lazy loading and fallback
        function generateProgressiveIcon(name, iconUrl) {
            var initial = name.charAt(0).toUpperCase();
            var colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];
            var colorIndex = name.charCodeAt(0) % colors.length;
            var color = colors[colorIndex];

            var fallbackSvg = '<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">';
            fallbackSvg += '<circle cx="32" cy="32" r="32" fill="' + color + '"/>';
            fallbackSvg += '<text x="32" y="42" text-anchor="middle" fill="white" font-size="28" font-weight="bold" font-family="system-ui">' + initial + '</text>';
            fallbackSvg += '</svg>';

            var html = '<div class="app-icon-container">';

            if (iconUrl) {
                // Image with lazy loading + onload to show when ready
                html += '<img src="' + iconUrl + '" alt="' + name + '" loading="lazy" decoding="async" onload="this.classList.add(\'loaded\')">';
            }

            // SVG fallback always present, fades out when image loads
            html += '<div class="icon-fallback">' + fallbackSvg + '</div>';
            html += '</div>';

            return html;
        }

        // Show empty state
        function showEmptyState(message) {
            var emptyState = document.getElementById('emptyState');
            emptyState.classList.remove('hidden');
            emptyState.querySelector('p').textContent = message || 'Nenhum aplicativo encontrado.';
            document.getElementById('appList').innerHTML = '';
        }

        // Validate PIN
        function validatePIN() {
            if (!supabaseClient) {
                showError('loginError', 'Configure o Supabase primeiro no painel Admin.');
                return;
            }

            var pin = document.getElementById('pinInput').value;

            if (!pin) {
                showError('loginError', 'Digite o PIN.');
                return;
            }

            supabaseClient
                .from('configuracoes')
                .select('pin_acesso')
                .limit(1)
                .single()
                .then(function (response) {
                    if (response.error) {
                        showError('loginError', 'Erro ao validar PIN.');
                        return;
                    }

                    if (response.data && response.data.pin_acesso === pin) {
                        localStorage.setItem('adminAuth', 'true');
                        localStorage.setItem('adminPin', pin);
                        navigateTo('#/admin/dashboard');
                    } else {
                        showError('loginError', 'PIN incorreto.');
                    }
                })
                .catch(function (error) {
                    console.error('Erro:', error);
                    showError('loginError', 'Erro ao conectar com o servidor.');
                });
        }

        // Logout
        function logout() {
            localStorage.removeItem('adminAuth');
            localStorage.removeItem('adminPin');
            navigateTo('#/admin');
        }

        // Switch admin tabs
        function switchTab(tab) {
            var tabUpload = document.getElementById('tabUpload');
            var tabManage = document.getElementById('tabManage');
            var tabStats = document.getElementById('tabStats');
            var tabSetup = document.getElementById('tabSetup');
            var uploadTab = document.getElementById('uploadTab');
            var manageTab = document.getElementById('manageTab');
            var statsTab = document.getElementById('statsTab');
            var setupTab = document.getElementById('setupTab');

            // Reset all tabs
            tabUpload.classList.remove('border-yellow-500', 'text-yellow-500');
            tabUpload.classList.add('border-transparent', 'text-zinc-400');
            tabManage.classList.remove('border-yellow-500', 'text-yellow-500');
            tabManage.classList.add('border-transparent', 'text-zinc-400');
            tabStats.classList.remove('border-yellow-500', 'text-yellow-500');
            tabStats.classList.add('border-transparent', 'text-zinc-400');
            tabSetup.classList.remove('border-yellow-500', 'text-yellow-500');
            tabSetup.classList.add('border-transparent', 'text-zinc-400');
            uploadTab.classList.add('hidden');
            manageTab.classList.add('hidden');
            statsTab.classList.add('hidden');
            setupTab.classList.add('hidden');

            // Activate selected tab
            if (tab === 'upload') {
                uploadTab.classList.remove('hidden');
                tabUpload.classList.add('border-yellow-500', 'text-yellow-500');
                tabUpload.classList.remove('border-transparent', 'text-zinc-400');

                // Set default upload date to today
                document.getElementById('appUploadDate').value = new Date().toISOString().split('T')[0];
            } else if (tab === 'manage') {
                manageTab.classList.remove('hidden');
                tabManage.classList.add('border-yellow-500', 'text-yellow-500');
                tabManage.classList.remove('border-transparent', 'text-zinc-400');
                loadManageApps();
            } else if (tab === 'stats') {
                statsTab.classList.remove('hidden');
                tabStats.classList.add('border-yellow-500', 'text-yellow-500');
                tabStats.classList.remove('border-transparent', 'text-zinc-400');
                loadStats();
            } else {
                setupTab.classList.remove('hidden');
                tabSetup.classList.add('border-yellow-500', 'text-yellow-500');
                tabSetup.classList.remove('border-transparent', 'text-zinc-400');
            }
        }

        // Load statistics
        function loadStats() {
            if (!supabaseClient) {
                document.getElementById('topAppsList').innerHTML = '<p class="text-red-400 text-center py-4">Configure o Supabase primeiro.</p>';
                return;
            }

            // Load apps stats
            supabaseClient.from('aplicativos').select('*').neq('ativo', false).then(function (response) {
                if (response.error) return;

                var apps = response.data || [];
                document.getElementById('statTotalApps').textContent = apps.length;

                // Calculate total downloads
                var totalDownloads = 0;
                for (var i = 0; i < apps.length; i++) {
                    totalDownloads += apps[i].downloads || 0;
                }
                document.getElementById('statTotalDownloads').textContent = totalDownloads;

                // Top 5 apps by downloads
                apps.sort(function (a, b) {
                    return (b.downloads || 0) - (a.downloads || 0);
                });

                var topApps = apps.slice(0, 5);
                if (topApps.length === 0) {
                    document.getElementById('topAppsList').innerHTML = '<p class="text-zinc-500 text-center py-4">Nenhum app ainda.</p>';
                } else {
                    var html = '';
                    for (var j = 0; j < topApps.length; j++) {
                        var app = topApps[j];
                        html += '<div class="flex items-center justify-between p-2 bg-zinc-950 rounded">';
                        html += '<span class="text-zinc-50">' + (j + 1) + '. ' + app.nome + '</span>';
                        html += '<span class="text-blue-400">' + (app.downloads || 0) + ' downloads</span>';
                        html += '</div>';
                    }
                    document.getElementById('topAppsList').innerHTML = html;
                }
            });

            // Load ratings stats
            supabaseClient.from('avaliacoes').select('positivo').then(function (response) {
                if (response.error) return;

                var ratings = response.data || [];
                var positive = 0;
                var negative = 0;

                for (var i = 0; i < ratings.length; i++) {
                    if (ratings[i].positivo) {
                        positive++;
                    } else {
                        negative++;
                    }
                }

                document.getElementById('statPositiveRatings').textContent = positive;
                document.getElementById('statNegativeRatings').textContent = negative;
            });

            // Also load storage stats
            loadStorageStats();
        }

        // Load storage statistics
        function loadStorageStats() {
            // Load Supabase Storage usage
            loadSupabaseStorageUsage();

            // Load GitHub Releases data
            loadGitHubReleasesData();
        }

        // Load Supabase Storage usage from app-icons bucket
        function loadSupabaseStorageUsage() {
            if (!supabaseClient) {
                document.getElementById('supabaseStorageUsed').textContent = 'Não configurado';
                return;
            }

            supabaseClient.storage.from('app-icons').list('', { limit: 1000 }).then(function (response) {
                if (response.error) {
                    document.getElementById('supabaseStorageUsed').textContent = 'Erro';
                    console.log('Storage error:', response.error);
                    return;
                }

                var files = response.data || [];
                var totalBytes = 0;
                var fileCount = 0;

                for (var i = 0; i < files.length; i++) {
                    if (files[i].metadata && files[i].metadata.size) {
                        totalBytes += files[i].metadata.size;
                        fileCount++;
                    }
                }

                // Format size
                var sizeText = formatBytes(totalBytes);
                document.getElementById('supabaseStorageUsed').textContent = sizeText + ' (' + fileCount + ' ícones)';

                // Update progress bar (1GB = 1073741824 bytes)
                var percentage = (totalBytes / 1073741824) * 100;
                document.getElementById('supabaseStorageBar').style.width = Math.min(percentage, 100) + '%';
            });
        }

        // Load GitHub Releases data
        function loadGitHubReleasesData() {
            var githubToken = localStorage.getItem('githubToken');
            var githubRepo = localStorage.getItem('githubRepo');

            if (!githubToken || !githubRepo) {
                document.getElementById('githubReleasesCount').textContent = 'Não configurado';
                document.getElementById('githubTotalDownloads').textContent = '-';
                return;
            }

            var url = 'https://api.github.com/repos/' + githubRepo + '/releases?per_page=100';

            fetch(url, {
                headers: {
                    'Authorization': 'token ' + githubToken,
                    'Accept': 'application/vnd.github.v3+json'
                }
            })
                .then(function (response) {
                    if (!response.ok) throw new Error('GitHub API error');
                    return response.json();
                })
                .then(function (releases) {
                    document.getElementById('githubReleasesCount').textContent = releases.length + ' releases';

                    var totalDownloads = 0;
                    for (var i = 0; i < releases.length; i++) {
                        var assets = releases[i].assets || [];
                        for (var j = 0; j < assets.length; j++) {
                            totalDownloads += assets[j].download_count || 0;
                        }
                    }

                    document.getElementById('githubTotalDownloads').textContent = totalDownloads + ' downloads';
                })
                .catch(function (error) {
                    console.log('GitHub API error:', error);
                    document.getElementById('githubReleasesCount').textContent = 'Erro';
                    document.getElementById('githubTotalDownloads').textContent = '-';
                });
        }

        // Format bytes to human readable
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            var k = 1024;
            var sizes = ['Bytes', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Export data
        function exportData(format) {
            if (!supabaseClient) {
                alert('Configure o Supabase primeiro.');
                return;
            }

            supabaseClient.from('aplicativos').select('*').then(function (response) {
                if (response.error) {
                    alert('Erro ao exportar dados.');
                    return;
                }

                var apps = response.data || [];
                var content = '';
                var filename = '';
                var mimeType = '';

                if (format === 'json') {
                    content = JSON.stringify(apps, null, 2);
                    filename = 'apps_export_' + new Date().toISOString().split('T')[0] + '.json';
                    mimeType = 'application/json';
                } else if (format === 'csv') {
                    // CSV header
                    var headers = ['id', 'nome', 'versao', 'versao_android', 'descricao', 'categoria', 'tamanho_mb', 'downloads', 'ativo', 'data_upload'];
                    content = headers.join(',') + '\n';

                    // CSV rows
                    for (var i = 0; i < apps.length; i++) {
                        var app = apps[i];
                        var row = [
                            app.id,
                            '"' + (app.nome || '').replace(/"/g, '""') + '"',
                            app.versao || '',
                            app.versao_android || '',
                            '"' + (app.descricao || '').replace(/"/g, '""').replace(/\n/g, ' ') + '"',
                            app.categoria || '',
                            app.tamanho_mb || '',
                            app.downloads || 0,
                            app.ativo !== false ? 'true' : 'false',
                            app.data_upload || ''
                        ];
                        content += row.join(',') + '\n';
                    }
                    filename = 'apps_export_' + new Date().toISOString().split('T')[0] + '.csv';
                    mimeType = 'text/csv';
                }

                downloadFile(content, filename, mimeType);
            });
        }

        // Export ratings
        function exportRatings() {
            if (!supabaseClient) {
                alert('Configure o Supabase primeiro.');
                return;
            }

            supabaseClient.from('avaliacoes').select('*, aplicativos(nome)').then(function (response) {
                if (response.error) {
                    alert('Erro ao exportar avaliações.');
                    return;
                }

                var ratings = response.data || [];
                var content = JSON.stringify(ratings, null, 2);
                var filename = 'avaliacoes_export_' + new Date().toISOString().split('T')[0] + '.json';
                downloadFile(content, filename, 'application/json');
            });
        }

        // Download file helper
        function downloadFile(content, filename, mimeType) {
            var blob = new Blob([content], { type: mimeType });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Load apps for management
        function loadManageApps() {
            if (!supabaseClient) {
                document.getElementById('manageAppsList').innerHTML = '<p class="text-red-400 text-center py-4">Configure o Supabase primeiro.</p>';
                return;
            }

            var showInactive = document.getElementById('showInactive').checked;
            var query = supabaseClient.from('aplicativos').select('*').order('data_upload', { ascending: false });

            if (!showInactive) {
                query = query.neq('ativo', false);
            }

            query.then(function (response) {
                if (response.error) {
                    document.getElementById('manageAppsList').innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar apps.</p>';
                    return;
                }

                var apps = response.data || [];
                if (apps.length === 0) {
                    document.getElementById('manageAppsList').innerHTML = '<p class="text-zinc-500 text-center py-8">Nenhum aplicativo encontrado.</p>';
                    return;
                }

                var html = '';
                for (var i = 0; i < apps.length; i++) {
                    var app = apps[i];
                    var isActive = app.ativo !== false;
                    var statusBadge = isActive
                        ? '<span class="px-2 py-1 text-xs bg-green-900 text-green-300 rounded">Ativo</span>'
                        : '<span class="px-2 py-1 text-xs bg-red-900 text-red-300 rounded">Inativo</span>';

                    html += '<div class="flex items-center justify-between p-3 bg-zinc-950 border border-zinc-800 rounded-md">';
                    html += '  <div class="flex-1 min-w-0">';
                    html += '    <div class="flex items-center gap-2">';
                    html += '      <span class="font-medium text-zinc-50 truncate">' + app.nome + '</span>';
                    html += '      ' + statusBadge;
                    html += '    </div>';
                    html += '    <p class="text-xs text-zinc-500">v' + (app.versao || '?') + ' • ' + (app.categoria || 'Sem categoria') + '</p>';
                    html += '  </div>';
                    html += '  <div class="flex gap-2">';
                    if (!isActive) {
                        html += '    <button onclick="toggleAppStatus(\'' + app.id + '\', true)" class="focusable px-3 py-1 text-sm bg-green-600 hover:bg-green-500 text-white rounded">Ativar</button>';
                    }
                    html += '    <button onclick="openEditModal(\'' + app.id + '\')" class="focusable px-3 py-1 text-sm bg-blue-600 hover:bg-blue-500 text-white rounded">✏️ Editar</button>';
                    html += '    <button onclick="openDeleteModal(\'' + app.id + '\', \'' + app.nome.replace(/'/g, "\\'") + '\')" class="focusable px-3 py-1 text-sm bg-red-600 hover:bg-red-500 text-white rounded">🗑️</button>';
                    html += '  </div>';
                    html += '</div>';
                }
                document.getElementById('manageAppsList').innerHTML = html;
            });
        }

        // Open edit modal
        function openEditModal(appId) {
            supabaseClient.from('aplicativos').select('*').eq('id', appId).single().then(function (response) {
                if (response.error) {
                    alert('Erro ao carregar dados do app');
                    return;
                }
                var app = response.data;
                document.getElementById('editAppId').value = app.id;
                document.getElementById('editAppName').value = app.nome || '';
                document.getElementById('editAppVersion').value = app.versao || '';
                document.getElementById('editAppVersionAndroid').value = app.versao_android || '';
                document.getElementById('editAppVersionDate').value = app.data_versao || '';
                document.getElementById('editAppCategory').value = app.categoria || '';
                document.getElementById('editAppUploadDate').value = app.data_upload ? app.data_upload.split('T')[0] : '';
                document.getElementById('editAppChangelog').value = app.changelog || '';
                document.getElementById('editAppModal').classList.remove('hidden');
            });
        }

        function closeEditModal() {
            document.getElementById('editAppModal').classList.add('hidden');
            document.getElementById('editAppStatus').classList.add('hidden');
        }

        // Save app edit
        function saveAppEdit() {
            var appId = document.getElementById('editAppId').value;
            var pin = localStorage.getItem('adminPin'); // Retrieve PIN

            if (!pin) {
                showStatus('editAppStatus', 'Sessão inválida. Faça login novamente.', 'error');
                return;
            }

            // Data to update
            var params = {
                p_id: appId,
                p_pin: pin,
                p_nome: document.getElementById('editAppName').value,
                p_versao: document.getElementById('editAppVersion').value,
                p_versao_android: document.getElementById('editAppVersionAndroid').value || null,
                p_data_versao: document.getElementById('editAppVersionDate').value || null,
                p_descricao: document.getElementById('editAppDescription').value || null,
                p_categoria: document.getElementById('editAppCategory').value || null,
                p_data_upload: document.getElementById('editAppUploadDate').value || null,
                p_changelog: document.getElementById('editAppChangelog').value || null
            };

            supabaseClient.rpc('admin_update_app', params).then(function (response) {
                if (response.error) {
                    showStatus('editAppStatus', 'Erro: ' + response.error.message, 'error');
                    return;
                }

                if (response.data === true) {
                    showStatus('editAppStatus', 'Alterações salvas com sucesso!', 'success');
                    setTimeout(function () {
                        closeEditModal();
                        loadManageApps();
                    }, 1000);
                } else {
                    showStatus('editAppStatus', 'Erro: PIN inválido ou permissão negada.', 'error');
                }
            }).catch(function (error) {
                showStatus('editAppStatus', 'Erro inesperado: ' + error.message, 'error');
            });
        }

        // Open delete modal
        function openDeleteModal(appId, appName) {
            document.getElementById('deleteAppId').value = appId;
            document.getElementById('deleteAppName').textContent = 'O que deseja fazer com "' + appName + '"?';
            document.getElementById('deleteAppModal').classList.remove('hidden');
            document.getElementById('deleteAppStatus').classList.add('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteAppModal').classList.add('hidden');
        }

        // Toggle app status (activate/deactivate)
        function toggleAppStatus(appIdOrActive, activate) {
            var appId;
            if (typeof appIdOrActive === 'boolean') {
                appId = document.getElementById('deleteAppId').value;
                activate = appIdOrActive;
            } else {
                appId = appIdOrActive;
            }

            supabaseClient.from('aplicativos').update({ ativo: activate }).eq('id', appId).then(function (response) {
                if (response.error) {
                    showStatus('deleteAppStatus', 'Erro: ' + response.error.message, 'error');
                    return;
                }
                if (!activate) {
                    showStatus('deleteAppStatus', 'App desativado com sucesso!', 'success');
                }
                setTimeout(function () {
                    closeDeleteModal();
                    loadManageApps();
                }, 500);
            });
        }

        // Delete app permanently
        function deleteAppPermanently() {
            var appId = document.getElementById('deleteAppId').value;
            var pin = localStorage.getItem('adminPin');

            if (!confirm('ATENÇÃO: Esta ação é irreversível. O app será excluído permanentemente. Deseja continuar?')) {
                return;
            }

            if (!pin) {
                alert('Sessão inválida. Por favor faça login novamente.');
                logout();
                return;
            }

            // Usar RPC segura
            supabaseClient
                .rpc('admin_delete_app', {
                    p_app_id: appId,
                    p_pin: pin
                })
                .then(function (response) {
                    if (response.error) {
                        showStatus('deleteAppStatus', 'Erro: ' + response.error.message, 'error');
                        return;
                    }

                    if (response.data === true) {
                        showStatus('deleteAppStatus', 'App excluído permanentemente!', 'success');
                        setTimeout(function () {
                            closeDeleteModal();
                            loadManageApps();
                        }, 1000);
                    } else {
                        showStatus('deleteAppStatus', 'Erro: PIN inválido ou permissão negada.', 'error');
                    }
                })
                .catch(function (err) {
                    showStatus('deleteAppStatus', 'Erro inesperado.', 'error');
                    console.error(err);
                });
        }

        // Rating modal functions
        function openRatingModal(appId, appName) {
            document.getElementById('ratingAppId').value = appId;
            document.getElementById('ratingAppName').textContent = appName;
            document.getElementById('ratingStep1').classList.remove('hidden');
            document.getElementById('ratingStep2').classList.add('hidden');
            document.getElementById('ratingNotTested').classList.add('hidden');
            document.getElementById('ratingStatus').classList.add('hidden');
            document.getElementById('ratingModal').classList.remove('hidden');
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.add('hidden');
        }

        function confirmTested(tested) {
            if (tested) {
                document.getElementById('ratingStep1').classList.add('hidden');
                document.getElementById('ratingStep2').classList.remove('hidden');
            } else {
                document.getElementById('ratingStep1').classList.add('hidden');
                document.getElementById('ratingNotTested').classList.remove('hidden');
            }
        }

        // Generate device ID for rating
        function getDeviceId() {
            var deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // Submit rating (from standalone modal)
        function submitRating(positive) {
            var appId = document.getElementById('ratingAppId').value;
            if (!appId || !supabaseClient) return;

            var deviceId = getDeviceId();

            showStatus('ratingStatus', 'Salvando avaliação...', 'info');

            supabaseClient.from('avaliacoes').upsert({
                aplicativo_id: appId,
                device_id: deviceId,
                positivo: positive,
                testou_app: true
            }, { onConflict: 'aplicativo_id,device_id' }).then(function (response) {
                if (response.error) {
                    console.error('Erro avaliação:', response.error);
                    showStatus('ratingStatus', 'Erro: ' + response.error.message, 'error');
                    return;
                }
                document.getElementById('ratingStep2').classList.add('hidden');
                showStatus('ratingStatus', positive ? '👍 Obrigado pelo feedback positivo!' : '👎 Obrigado pelo feedback!', 'success');
                setTimeout(function () {
                    closeRatingModal();
                    renderStore();
                }, 1500);
            }).catch(function (err) {
                showStatus('ratingStatus', 'Erro de conexão.', 'error');
            });
        }


        // Open app details modal
        function openDetailsModal(appId) {
            var app = null;
            for (var i = 0; i < allApps.length; i++) {
                if (allApps[i].id === appId) {
                    app = allApps[i];
                    break;
                }
            }
            if (!app) return;

            document.getElementById('detailsAppId').value = app.id;
            document.getElementById('detailsAppName').textContent = app.nome;
            document.getElementById('detailsAppDescription').textContent = app.descricao || 'Sem descrição';
            document.getElementById('detailsAppCategory').textContent = app.categoria || 'Sem categoria';
            document.getElementById('detailsAppSize').textContent = app.tamanho_mb ? app.tamanho_mb + ' MB' : 'N/A';
            document.getElementById('detailsAppVersion').textContent = app.versao ? 'Versão do Sistema: ' + app.versao : '';
            document.getElementById('detailsAppVersionAndroid').textContent = app.versao_android ? 'Versão Android: ' + app.versao_android : '';

            // Dates
            var versionDate = app.data_versao ? new Date(app.data_versao).toLocaleDateString('pt-BR') : 'Não informada';
            var uploadDate = app.data_upload ? new Date(app.data_upload).toLocaleDateString('pt-BR') : 'Não informada';

            document.getElementById('detailsAppDate').textContent = 'Lançamento original: ' + versionDate;
            document.getElementById('detailsUploadDate').textContent = 'Subido na loja em: ' + uploadDate;

            // Changelog
            if (app.changelog) {
                document.getElementById('detailsChangelogSection').classList.remove('hidden');
                document.getElementById('detailsAppChangelog').textContent = app.changelog;
            } else {
                document.getElementById('detailsChangelogSection').classList.add('hidden');
            }

            // Icon
            var iconHtml = app.icone_url
                ? '<img src="' + app.icone_url + '" class="w-20 h-20 object-cover">'
                : generateFallbackIcon(app.nome);
            document.getElementById('detailsAppIcon').innerHTML = iconHtml;

            // Ratings
            var rating = allRatings[app.id] || { positivo: 0, negativo: 0 };
            document.getElementById('detailsPositive').textContent = rating.positivo;
            document.getElementById('detailsNegative').textContent = rating.negativo;

            // Downloads
            var downloads = app.downloads || 0;
            document.getElementById('detailsDownloads').textContent = downloads + ' download' + (downloads !== 1 ? 's' : '');

            // Download button
            document.getElementById('detailsDownloadBtn').href = app.apk_url;

            // Load version history
            loadVersionHistory(app.id, app.nome);

            document.getElementById('appDetailsModal').classList.remove('hidden');
        }

        // Load version history for an app
        function loadVersionHistory(currentAppId, appName) {
            document.getElementById('versionHistorySection').classList.add('hidden');
            document.getElementById('versionHistoryList').innerHTML = '<p class="text-zinc-500 text-sm">Carregando...</p>';

            if (!supabaseClient) return;

            // Find all versions of the same app by name
            supabaseClient
                .from('aplicativos')
                .select('id, versao, versao_android, data_upload, apk_url')
                .eq('nome', appName)
                .neq('id', currentAppId)
                .neq('ativo', false)
                .order('data_upload', { ascending: false })
                .then(function (response) {
                    if (response.error || !response.data || response.data.length === 0) {
                        document.getElementById('versionHistorySection').classList.add('hidden');
                        return;
                    }

                    var versions = response.data;
                    var html = '';

                    for (var i = 0; i < versions.length; i++) {
                        var v = versions[i];
                        var versionText = v.versao ? 'v' + v.versao : 'Versão antiga';
                        if (v.versao_android) versionText += ' (Android: ' + v.versao_android + ')';

                        var dateText = '';
                        if (v.data_upload) {
                            var d = new Date(v.data_upload);
                            dateText = d.toLocaleDateString('pt-BR');
                        }

                        html += '<div class="flex items-center justify-between p-2 bg-zinc-950 rounded">';
                        html += '  <div>';
                        html += '    <span class="text-zinc-300 text-sm">' + versionText + '</span>';
                        if (dateText) html += '    <span class="text-zinc-600 text-xs ml-2">' + dateText + '</span>';
                        html += '  </div>';
                        html += '  <a href="' + v.apk_url + '" download onclick="trackDownloadFromHome(\'' + v.id + '\')" class="focusable px-3 py-1 text-xs bg-zinc-700 hover:bg-zinc-600 text-zinc-50 rounded">Download</a>';
                        html += '</div>';
                    }

                    document.getElementById('versionHistoryList').innerHTML = html;
                    document.getElementById('versionHistorySection').classList.remove('hidden');
                });
        }

        function closeDetailsModal() {
            document.getElementById('appDetailsModal').classList.add('hidden');
        }

        // Rate from details modal (skip test confirmation for simplicity)
        function rateFromDetails(positive) {
            var appId = document.getElementById('detailsAppId').value;
            if (!appId || !supabaseClient) return;

            var deviceId = getDeviceId();

            console.log('Enviando avaliação:', { aplicativo_id: appId, device_id: deviceId, positivo: positive });

            supabaseClient.from('avaliacoes').upsert({
                aplicativo_id: appId,
                device_id: deviceId,
                positivo: positive,
                testou_app: true
            }, { onConflict: 'aplicativo_id,device_id' }).then(function (response) {
                if (response.error) {
                    console.error('Erro detalhes:', response.error);
                    alert('Erro ao salvar avaliação: ' + response.error.message);
                    return;
                }
                alert(positive ? '👍 Obrigado pelo feedback!' : '👎 Obrigado pelo feedback!');
                closeDetailsModal();
                renderStore();
            }).catch(function (err) {
                console.error('Erro de conexão:', err);
                alert('Erro de conexão ao salvar avaliação.');
            });
        }

        // Show Toast Notification
        function showToast(message, type) {
            var toast = document.getElementById("toast");
            toast.className = "toast show";
            if (type) toast.classList.add(type);
            toast.textContent = message;
            setTimeout(function () {
                toast.className = toast.className.replace("show", "");
                if (type) toast.classList.remove(type);
            }, 3000);
        }

        // Track download
        function trackDownload() {
            var appId = document.getElementById('detailsAppId').value;
            if (!appId || !supabaseClient) return;

            console.log('Iniciando download (Modal) para app:', appId);
            showToast("Iniciando download...", "success");

            // Increment download counter via RPC
            supabaseClient.rpc('increment_downloads', { app_id: appId }).then(function (response) {
                if (response.error) {
                    console.error('Erro download:', response.error);
                } else {
                    console.log('Download registrado');
                    setTimeout(renderStore, 1000);
                }
            }).catch(function (err) {
                console.error('Erro de conexão no download');
            });
        }

        // Track download from home page (receives appId directly)
        function trackDownloadFromHome(appId) {
            if (!appId || !supabaseClient) return;

            console.log('Iniciando download (Home) para app:', appId);
            showToast("Download iniciado!", "success");

            supabaseClient.rpc('increment_downloads', { app_id: appId }).then(function (response) {
                if (response.error) {
                    console.error('Erro download home:', response.error);
                } else {
                    console.log('Download registrado (home)');
                }
            }).catch(function (err) {
                console.error('Erro de conexão no download (home)');
            });
        }


        // Save setup to localStorage
        function saveSetup() {
            var githubToken = document.getElementById('githubToken').value;
            var githubRepo = document.getElementById('githubRepo').value;
            var supabaseUrl = document.getElementById('supabaseUrl').value;
            var supabaseKey = document.getElementById('supabaseKey').value;

            if (!githubToken || !githubRepo || !supabaseUrl || !supabaseKey) {
                showStatus('setupStatus', 'Preencha todos os campos.', 'error');
                return;
            }

            localStorage.setItem('githubToken', githubToken);
            localStorage.setItem('githubRepo', githubRepo);
            localStorage.setItem('supabaseUrl', supabaseUrl);
            localStorage.setItem('supabaseKey', supabaseKey);

            // Reinitialize Supabase client
            loadSetup();

            showStatus('setupStatus', 'Configurações salvas com sucesso!', 'success');
        }

        // Load setup values into form
        function loadSetupValues() {
            document.getElementById('githubToken').value = localStorage.getItem('githubToken') || '';
            document.getElementById('githubRepo').value = localStorage.getItem('githubRepo') || '';
            document.getElementById('supabaseUrl').value = localStorage.getItem('supabaseUrl') || '';
            document.getElementById('supabaseKey').value = localStorage.getItem('supabaseKey') || '';
        }

        // Test GitHub connection and credentials
        function testGitHubConnection() {
            var githubToken = localStorage.getItem('githubToken');
            var githubRepo = localStorage.getItem('githubRepo');

            // Clear previous status
            showStatus('setupStatus', '', 'info');

            // Step 1: Validate credentials exist
            if (!githubToken || !githubRepo) {
                showStatus('setupStatus', '❌ Erro: Configure GitHub Token e Repo primeiro!', 'error');
                return;
            }

            // Step 2: Validate token format
            if (!githubToken.startsWith('ghp_') && !githubToken.startsWith('github_pat_')) {
                showStatus('setupStatus', '⚠️ Aviso: Token GitHub não parece ter formato válido (deve começar com ghp_ ou github_pat_)', 'error');
                return;
            }

            // Step 3: Validate repo format
            if (githubRepo.split('/').length !== 2) {
                showStatus('setupStatus', '❌ Erro: Formato do repositório inválido. Use: usuario/repositorio', 'error');
                return;
            }

            showStatus('setupStatus', '🔄 Testando conexão com GitHub API...', 'info');

            // Step 4: Test API connection
            fetch('https://api.github.com/repos/' + githubRepo, {
                method: 'GET',
                headers: {
                    'Authorization': 'token ' + githubToken,
                    'Accept': 'application/vnd.github.v3+json'
                }
            })
                .then(function (response) {
                    if (response.status === 404) {
                        throw new Error('Repositório não encontrado. Verifique se o nome está correto e se existe.');
                    }
                    if (response.status === 401) {
                        throw new Error('Token inválido ou expirado. Gere um novo token no GitHub.');
                    }
                    if (response.status === 403) {
                        throw new Error('Token sem permissões necessárias. Certifique-se de marcar o escopo "repo".');
                    }
                    if (!response.ok) {
                        throw new Error('Erro HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(function (repo) {
                    var message = '✅ Sucesso! Conexão OK\\n\\n';
                    message += '📦 Repositório: ' + repo.full_name + '\\n';
                    message += '🔒 Privado: ' + (repo.private ? 'Sim' : 'Não') + '\\n';
                    message += '✍️ Proprietário: ' + repo.owner.login + '\\n';
                    message += '📝 Descrição: ' + (repo.description || 'Sem descrição');

                    showStatus('setupStatus', message, 'success');
                })
                .catch(function (error) {
                    var message = '❌ Erro ao conectar:\\n\\n';
                    message += error.message + '\\n\\n';
                    message += '📋 Verifique:\\n';
                    message += '• Token tem escopo "repo" ativado\\n';
                    message += '• Repositório existe e está acessível\\n';
                    message += '• Token não expirou';

                    showStatus('setupStatus', message, 'error');
                    console.error('Erro detalhado:', error);
                });
        }

        // Upload APK via fluxo híbrido (ES5 compatível com TV Box)
        // 1. Edge Function create-release cria release no GitHub (leve)
        // 2. Navegador faz upload do APK direto para uploads.github.com
        // 3. Edge Function save-metadata salva no banco
        function uploadAPK() {
            var name = document.getElementById('appName').value;
            var version = document.getElementById('appVersion').value;
            var versionAndroid = document.getElementById('appVersionAndroid').value;
            var versionDate = document.getElementById('appVersionDate').value;
            var uploadDate = document.getElementById('appUploadDate').value;
            var description = document.getElementById('appDescription').value;
            var category = document.getElementById('appCategory').value;
            var changelog = document.getElementById('appChangelog').value;
            var iconInput = document.getElementById('iconFile');
            var iconFile = iconInput.files[0];
            var fileInput = document.getElementById('apkFile');
            var file = fileInput.files[0];

            // Validation - only APK is required
            if (!file) {
                showStatus('uploadStatus', 'Selecione o arquivo APK.', 'error');
                return;
            }

            if (!supabaseClient) {
                showStatus('uploadStatus', 'Configure o Supabase primeiro.', 'error');
                return;
            }

            var githubToken = localStorage.getItem('githubToken');
            var githubRepo = localStorage.getItem('githubRepo');
            var supabaseUrl = localStorage.getItem('supabaseUrl');
            var supabaseKey = localStorage.getItem('supabaseKey');

            if (!githubToken || !githubRepo) {
                showStatus('uploadStatus', 'Configure GitHub Token e Repo na aba Setup.', 'error');
                return;
            }

            // Disable button
            var uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<div class="spinner mx-auto"></div>';

            // Step 0.1: Auto-fill name from APK filename if empty
            if (!name) {
                name = file.name.replace('.apk', '').replace(/[_-]/g, ' ');
                name = name.charAt(0).toUpperCase() + name.slice(1);
                document.getElementById('appName').value = name;
                showStatus('uploadStatus', 'Nome detectado do arquivo: ' + name, 'info');
            }

            var processUpload = function (finalVersion) {
                version = finalVersion;
                document.getElementById('appVersion').value = version;

                var fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                showStatus('uploadStatus', 'Criando release no GitHub...', 'info');

                // Preparar ícone como base64 (ES5 compatível)
                var prepareIcon = function (callback) {
                    if (!iconFile || iconFile.size > 500000) {
                        callback(null, null, null);
                        return;
                    }
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var base64 = e.target.result.split(',')[1];
                        callback(base64, iconFile.name, iconFile.type);
                    };
                    reader.onerror = function () {
                        callback(null, null, null);
                    };
                    reader.readAsDataURL(iconFile);
                };

                prepareIcon(function (iconBase64, iconName, iconType) {
                    // Step 1: Chamar Edge Function create-release
                    var createReleaseUrl = supabaseUrl + '/functions/v1/create-release';

                    fetch(createReleaseUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + supabaseKey,
                            'x-github-token': githubToken,
                            'x-github-repo': githubRepo,
                            'x-supabase-url': supabaseUrl,
                            'x-supabase-key': supabaseKey
                        },
                        body: JSON.stringify({
                            name: name,
                            version: version,
                            description: description || '',
                            category: category || '',
                            changelog: changelog || '',
                            versionAndroid: versionAndroid || '',
                            versionDate: versionDate || '',
                            uploadDate: uploadDate || new Date().toISOString().split('T')[0],
                            iconBase64: iconBase64,
                            iconName: iconName,
                            iconType: iconType
                        })
                    })
                        .then(function (response) {
                            if (!response.ok) {
                                return response.text().then(function (text) {
                                    var errMsg = 'Erro ' + response.status;
                                    try {
                                        var data = JSON.parse(text);
                                        errMsg = data.error || errMsg;
                                    } catch (e) { }
                                    throw new Error(errMsg);
                                });
                            }
                            return response.json();
                        })
                        .then(function (result) {
                            if (!result.success) {
                                throw new Error(result.error || 'Erro ao criar release');
                            }

                            var uploadUrl = result.data.upload_url;
                            var iconUrl = result.data.icon_url;

                            if (!uploadUrl) {
                                throw new Error('Release criado mas upload_url não retornado');
                            }

                            showStatus('uploadStatus', 'Enviando APK (' + fileSizeMB + ' MB)... Por favor aguarde.', 'info');

                            // Step 2: Upload APK direto para uploads.github.com
                            var finalUploadUrl = uploadUrl.replace('{?name,label}', '?name=' + encodeURIComponent(file.name));

                            // Usar FileReader para compatibilidade ES5
                            var apkReader = new FileReader();
                            apkReader.onload = function (e) {
                                var buffer = e.target.result;

                                fetch(finalUploadUrl, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': 'token ' + githubToken,
                                        'Content-Type': 'application/vnd.android.package-archive',
                                        'Accept': 'application/vnd.github.v3+json'
                                    },
                                    body: buffer
                                })
                                    .then(function (assetResponse) {
                                        if (!assetResponse.ok) {
                                            return assetResponse.text().then(function (text) {
                                                var errMsg = 'Erro ao enviar APK: ' + assetResponse.status;
                                                try {
                                                    var data = JSON.parse(text);
                                                    errMsg = data.message || errMsg;
                                                } catch (e) { }
                                                throw new Error(errMsg);
                                            });
                                        }
                                        return assetResponse.json();
                                    })
                                    .then(function (asset) {
                                        var apkUrl = asset.browser_download_url;

                                        showStatus('uploadStatus', 'APK enviado! Salvando no banco...', 'info');

                                        // Step 3: Salvar metadados via Edge Function
                                        var saveMetadataUrl = supabaseUrl + '/functions/v1/save-metadata';

                                        return fetch(saveMetadataUrl, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': 'Bearer ' + supabaseKey,
                                                'x-supabase-url': supabaseUrl,
                                                'x-supabase-key': supabaseKey
                                            },
                                            body: JSON.stringify({
                                                name: name,
                                                version: version,
                                                description: description || '',
                                                category: category || '',
                                                changelog: changelog || '',
                                                versionAndroid: versionAndroid || '',
                                                versionDate: versionDate || '',
                                                uploadDate: uploadDate || new Date().toISOString().split('T')[0],
                                                iconUrl: iconUrl,
                                                apkUrl: apkUrl,
                                                sizeMB: fileSizeMB
                                            })
                                        });
                                    })
                                    .then(function (saveResponse) {
                                        return saveResponse.json();
                                    })
                                    .then(function (saveResult) {
                                        if (!saveResult.success) {
                                            console.warn('Aviso ao salvar:', saveResult.error);
                                            showStatus('uploadStatus', 'APK enviado! (Aviso: ' + (saveResult.error || 'erro ao salvar') + ')', 'success');
                                        } else {
                                            showStatus('uploadStatus', 'Upload concluído com sucesso! (v' + version + ')', 'success');
                                        }

                                        // Clear form
                                        document.getElementById('appName').value = '';
                                        document.getElementById('appVersion').value = '';
                                        document.getElementById('appVersionAndroid').value = '';
                                        document.getElementById('appVersionDate').value = '';
                                        document.getElementById('appDescription').value = '';
                                        document.getElementById('appCategory').value = '';
                                        document.getElementById('appChangelog').value = '';
                                        document.getElementById('iconFile').value = '';
                                        fileInput.value = '';

                                        uploadBtn.disabled = false;
                                        uploadBtn.textContent = 'Upload para GitHub Releases';

                                        if (currentView === 'store') {
                                            renderStore();
                                        }
                                    })
                                    .catch(function (error) {
                                        console.error('Erro no upload APK:', error);
                                        showStatus('uploadStatus', 'Erro: ' + error.message, 'error');
                                        uploadBtn.disabled = false;
                                        uploadBtn.textContent = 'Upload para GitHub Releases';
                                    });
                            };
                            apkReader.onerror = function () {
                                showStatus('uploadStatus', 'Erro ao ler arquivo APK', 'error');
                                uploadBtn.disabled = false;
                                uploadBtn.textContent = 'Upload para GitHub Releases';
                            };
                            apkReader.readAsArrayBuffer(file);
                        })
                        .catch(function (error) {
                            console.error('Erro ao criar release:', error);
                            showStatus('uploadStatus', 'Erro: ' + error.message, 'error');
                            uploadBtn.disabled = false;
                            uploadBtn.textContent = 'Upload para GitHub Releases';
                        });
                });
            };

            // Step 0.2: Auto-detect version if empty
            if (!version) {
                showStatus('uploadStatus', 'Detectando versão automaticamente...', 'info');

                supabaseClient
                    .from('aplicativos')
                    .select('versao')
                    .eq('nome', name)
                    .order('created_at', { ascending: false })
                    .then(function (response) {
                        if (response.error) {
                            console.warn('Erro ao buscar versões:', response.error);
                            processUpload('1.0');
                            return;
                        }

                        var existingVersions = response.data || [];

                        if (existingVersions.length === 0) {
                            processUpload('1.0');
                        } else {
                            var maxVersion = 1.0;
                            for (var i = 0; i < existingVersions.length; i++) {
                                var v = parseFloat(existingVersions[i].versao);
                                if (!isNaN(v) && v >= maxVersion) {
                                    maxVersion = v;
                                }
                            }
                            var newVersion = (maxVersion + 0.1).toFixed(1);
                            processUpload(newVersion);
                        }
                    })
                    .catch(function (error) {
                        console.error('Erro ao verificar versões:', error);
                        processUpload('1.0');
                    });
            } else {
                processUpload(version);
            }
        }

        // Show status message
        function showStatus(elementId, message, type) {
            var element = document.getElementById(elementId);
            element.classList.remove('hidden');

            var bgColor = type === 'error' ? 'bg-red-950 border-red-900 text-red-200' :
                type === 'success' ? 'bg-green-950 border-green-900 text-green-200' :
                    'bg-blue-950 border-blue-900 text-blue-200';

            element.className = 'mt-4 p-3 rounded-md text-sm border ' + bgColor;
            element.textContent = message;
        }

        // Show error message
        function showError(elementId, message) {
            var element = document.getElementById(elementId);
            element.classList.remove('hidden');
            element.textContent = message;
        }

        // Open help modal
        function openHelpModal() {
            document.getElementById('helpModal').classList.remove('hidden');
        }

        // Close help modal
        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
        }

        // Open setup modal
        function openSetupModal() {
            // Load existing values if any
            document.getElementById('setupModalSupabaseUrl').value = localStorage.getItem('supabaseUrl') || '';
            document.getElementById('setupModalSupabaseKey').value = localStorage.getItem('supabaseKey') || '';
            document.getElementById('setupModalGithubToken').value = localStorage.getItem('githubToken') || '';
            document.getElementById('setupModalGithubRepo').value = localStorage.getItem('githubRepo') || '';

            document.getElementById('setupModal').classList.remove('hidden');
        }

        // Close setup modal
        function closeSetupModal() {
            document.getElementById('setupModal').classList.add('hidden');
        }

        // Save setup from modal
        function saveSetupFromModal() {
            var supabaseUrl = document.getElementById('setupModalSupabaseUrl').value;
            var supabaseKey = document.getElementById('setupModalSupabaseKey').value;
            var githubToken = document.getElementById('setupModalGithubToken').value;
            var githubRepo = document.getElementById('setupModalGithubRepo').value;

            if (!supabaseUrl || !supabaseKey) {
                showStatus('setupModalStatus', 'Preencha pelo menos a URL e a chave do Supabase.', 'error');
                return;
            }

            localStorage.setItem('supabaseUrl', supabaseUrl);
            localStorage.setItem('supabaseKey', supabaseKey);

            if (githubToken) localStorage.setItem('githubToken', githubToken);
            if (githubRepo) localStorage.setItem('githubRepo', githubRepo);

            // Reinitialize Supabase client
            loadSetup();

            showStatus('setupModalStatus', 'Configurações salvas! Você já pode fazer login com o PIN.', 'success');

            setTimeout(function () {
                closeSetupModal();
            }, 2000);
        }

        // Setup keyboard navigation for D-Pad
        function setupKeyboardNav() {
            var focusableElements = [];
            var currentFocusIndex = -1;

            // Update focusable elements list
            function updateFocusableElements() {
                focusableElements = Array.prototype.slice.call(
                    document.querySelectorAll('.focusable:not([disabled])')
                ).filter(function (el) {
                    return el.offsetParent !== null; // Only visible elements
                });
            }

            // Handle keyboard events
            document.addEventListener('keydown', function (e) {
                updateFocusableElements();

                if (focusableElements.length === 0) return;

                // Arrow Down or Tab
                if (e.key === 'ArrowDown' || (e.key === 'Tab' && !e.shiftKey)) {
                    e.preventDefault();
                    currentFocusIndex = (currentFocusIndex + 1) % focusableElements.length;
                    focusableElements[currentFocusIndex].focus();
                }
                // Arrow Up or Shift+Tab
                else if (e.key === 'ArrowUp' || (e.key === 'Tab' && e.shiftKey)) {
                    e.preventDefault();
                    currentFocusIndex = currentFocusIndex <= 0 ? focusableElements.length - 1 : currentFocusIndex - 1;
                    focusableElements[currentFocusIndex].focus();
                }
                // Escape - close modals
                else if (e.key === 'Escape') {
                    closeHelpModal();
                }
            });

            // Track current focus
            document.addEventListener('focus', function (e) {
                var index = focusableElements.indexOf(e.target);
                if (index !== -1) {
                    currentFocusIndex = index;
                }
            }, true);
        }

        // Close modal on overlay click
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('modal-overlay')) {
                closeHelpModal();
                closeSetupModal();
            }
        });

        // Real-time auto-fill for APK Name
        document.addEventListener('DOMContentLoaded', function () {
            var apkInput = document.getElementById('apkFile');
            if (apkInput) {
                apkInput.addEventListener('change', function (e) {
                    var file = e.target.files[0];
                    if (file) {
                        var nameInput = document.getElementById('appName');
                        if (!nameInput.value) {
                            var name = file.name.replace('.apk', '').replace(/[_-]/g, ' ');
                            name = name.charAt(0).toUpperCase() + name.slice(1);
                            nameInput.value = name;
                        }
                    }
                });
            }
        });
    </script>
    <script>
        // PWA Install Logic - Com memória de escolha do usuário (ES5 para TV Box)
        var deferredPrompt = null;
        var installBanner = document.getElementById('installBanner');
        var BANNER_DISMISSED_KEY = 'pwa_banner_dismissed';
        var BANNER_INSTALLED_KEY = 'pwa_installed';

        // Verifica se deve mostrar o banner
        function shouldShowBanner() {
            // Se já instalou, nunca mostra
            if (localStorage.getItem(BANNER_INSTALLED_KEY)) {
                return false;
            }
            // Se clicou "Depois", verifica se já passou 7 dias
            var dismissed = localStorage.getItem(BANNER_DISMISSED_KEY);
            if (dismissed) {
                var dismissedDate = new Date(parseInt(dismissed));
                var now = new Date();
                var daysPassed = (now - dismissedDate) / (1000 * 60 * 60 * 24);
                if (daysPassed < 7) {
                    return false;
                }
            }
            return true;
        }

        // Mostra banner se permitido
        function showBannerIfAllowed() {
            if (shouldShowBanner() && installBanner) {
                installBanner.style.opacity = "1";
                installBanner.classList.remove('hidden');
            } else if (installBanner) {
                installBanner.classList.add('hidden');
            }
        }

        // Inicializa - mostra banner se permitido
        document.addEventListener('DOMContentLoaded', showBannerIfAllowed);

        window.addEventListener('beforeinstallprompt', function (e) {
            e.preventDefault();
            deferredPrompt = e;
            showBannerIfAllowed();
        });

        function installPWA() {
            if (!deferredPrompt) {
                // Se não há prompt disponível, apenas fecha o banner
                closeInstallBanner();
                return;
            }

            closeInstallBanner();
            deferredPrompt.prompt();

            deferredPrompt.userChoice.then(function (choiceResult) {
                console.log('Resposta do usuário: ' + choiceResult.outcome);
                if (choiceResult.outcome === 'accepted') {
                    localStorage.setItem(BANNER_INSTALLED_KEY, 'true');
                }
                deferredPrompt = null;
            });
        }

        function closeInstallBanner() {
            var banner = document.getElementById('installBanner');
            if (banner) {
                // Salva que o usuário clicou "Depois"
                localStorage.setItem(BANNER_DISMISSED_KEY, Date.now().toString());

                banner.style.transition = "opacity 0.5s ease";
                banner.style.opacity = "0";
                setTimeout(function () { banner.classList.add('hidden'); }, 500);
            }
        }

        // Se o app for instalado
        window.addEventListener('appinstalled', function () {
            console.log('PWA instalado com sucesso!');
            localStorage.setItem(BANNER_INSTALLED_KEY, 'true');
            if (installBanner) installBanner.classList.add('hidden');
            deferredPrompt = null;
        });

        // Registro do Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('./sw.js')
                    .then(function (reg) {
                        console.log('SW registrado com sucesso!', reg.scope);
                        reg.onupdatefound = function () {
                            var installingWorker = reg.installing;
                            installingWorker.onstatechange = function () {
                                if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('Nova versão disponível! Por favor, recarregue.');
                                }
                            };
                        };
                    })
                    .catch(function (err) { console.log('Erro ao registrar SW:', err); });
            });
        }
    </script>
</body>

</html>