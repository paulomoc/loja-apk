<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#09090b">
    <title>Loja de APKs Privada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* shadcn/ui inspired design system - Zinc palette */
        :root {
            --bg-primary: #09090b;
            --bg-card: #18181b;
            --border: #27272a;
            --text-primary: #fafafa;
            --text-muted: #a1a1aa;
            --accent: #facc15;
        }
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        /* Focus styles for D-Pad navigation */
        .focusable:focus {
            outline: 4px solid var(--accent);
            transform: scale(1.05);
            z-index: 10;
        }
        /* Smooth transitions */
        .focusable {
            transition: all 0.2s ease;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-card);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        /* Modal overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        /* Loading spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Hide elements */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Store View -->
    <div id="storeView" class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-3xl font-bold text-zinc-50">Loja de APKs</h1>
                <div class="flex gap-2">
                    <button onclick="openHelpModal()"
                        class="focusable px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-50 rounded-md border border-zinc-700 text-sm">
                        Ajuda
                    </button>
                    <button onclick="navigateTo('#/admin')"
                        class="focusable px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-50 rounded-md border border-zinc-700 text-sm">
                        Admin
                    </button>
                </div>
            </div>
            <!-- Search bar -->
            <input type="text" id="searchInput" placeholder="Buscar aplicativos..."
                class="focusable w-full px-4 py-3 bg-zinc-900 border border-zinc-800 rounded-md text-zinc-50 placeholder-zinc-500 focus:border-zinc-700"
                oninput="filterApps()">
        </header>
        <!-- APK List -->
        <div id="appList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Apps will be loaded here -->
        </div>
        <!-- Loading state -->
        <div id="storeLoading" class="text-center py-12">
            <div class="spinner mx-auto"></div>
            <p class="text-zinc-500 mt-4">Carregando aplicativos...</p>
        </div>
        <!-- Empty state -->
        <div id="emptyState" class="hidden text-center py-12">
            <p class="text-zinc-500">Nenhum aplicativo encontrado.</p>
        </div>
    </div>
    <!-- Admin Login View -->
    <div id="adminLoginView" class="hidden container mx-auto px-4 py-6 max-w-md">
        <div class="bg-zinc-900 border border-zinc-800 rounded-md p-8">
            <h2 class="text-2xl font-bold mb-6 text-zinc-50">Admin Login</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">PIN de Acesso</label>
                    <input type="password" id="pinInput"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Digite o PIN">
                </div>
                <button onclick="validatePIN()"
                    class="focusable w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                    Entrar
                </button>
                <button onclick="openSetupModal()"
                    class="focusable w-full px-4 py-2 bg-blue-600 hover:bg-blue-500 text-zinc-50 rounded-md">
                    Configurar Credenciais
                </button>
                <button onclick="navigateTo('#/')"
                    class="focusable w-full px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-50 rounded-md border border-zinc-700">
                    Voltar
                </button>
            </div>
            <div id="loginError"
                class="hidden mt-4 p-3 bg-red-950 border border-red-900 rounded-md text-red-200 text-sm"></div>
            <div class="mt-4 p-3 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-400 text-xs">
                <p><strong>Primeira vez?</strong> Clique em "Configurar Credenciais" para adicionar suas chaves do
                    Supabase e GitHub antes de fazer login.</p>
            </div>
        </div>
    </div>
    <!-- Admin Dashboard View -->
    <div id="adminDashboardView" class="hidden container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-zinc-50">Painel Admin</h1>
            <button onclick="logout()"
                class="focusable px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-50 rounded-md border border-zinc-700">
                Sair
            </button>
        </div>
        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-zinc-800">
            <button id="tabUpload" onclick="switchTab('upload')"
                class="focusable px-4 py-2 border-b-2 border-yellow-500 text-yellow-500 font-medium">
                Upload APK
            </button>
            <button id="tabSetup" onclick="switchTab('setup')"
                class="focusable px-4 py-2 border-b-2 border-transparent text-zinc-400 hover:text-zinc-50">
                Setup
            </button>
        </div>
        <!-- Upload Tab -->
        <div id="uploadTab" class="bg-zinc-900 border border-zinc-800 rounded-md p-6">
            <h3 class="text-xl font-semibold mb-4 text-zinc-50">Upload de APK</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Nome do App (opcional - detecta do arquivo)</label>
                    <input type="text" id="appName"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Ex: Meu Aplicativo">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Vers√£o (opcional - auto-incrementa)</label>
                    <input type="text" id="appVersion"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Ex: 1.0.0">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Descri√ß√£o</label>
                    <textarea id="appDescription" rows="3"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Descri√ß√£o do aplicativo..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Categoria (opcional)</label>
                    <input type="text" id="appCategory"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="Ex: Produtividade, Jogos, Ferramentas">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">√çcone do App (PNG/JPG)</label>
                    <input type="file" id="iconFile" accept="image/png,image/jpeg,image/jpg"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-blue-600 file:text-zinc-50 file:font-medium hover:file:bg-blue-500">
                    <p class="text-xs text-zinc-500 mt-1">Recomendado: 512x512px, PNG transparente</p>
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Arquivo APK</label>
                    <input type="file" id="apkFile" accept=".apk"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-yellow-500 file:text-zinc-950 file:font-medium hover:file:bg-yellow-400">
                </div>
                <button onclick="uploadAPK()" id="uploadBtn"
                    class="focusable w-full px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                    Upload para GitHub Releases
                </button>
            </div>
            <div id="uploadStatus" class="hidden mt-4"></div>
        </div>
        <!-- Setup Tab -->
        <div id="setupTab" class="hidden bg-zinc-900 border border-zinc-800 rounded-md p-6">
            <h3 class="text-xl font-semibold mb-4 text-zinc-50">Configura√ß√µes</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">GitHub Token</label>
                    <input type="password" id="githubToken"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="ghp_...">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">GitHub Repo Path</label>
                    <input type="text" id="githubRepo"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="usuario/repositorio">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Supabase URL</label>
                    <input type="text" id="supabaseUrl"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="https://xxx.supabase.co">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Supabase Anon Key</label>
                    <input type="password" id="supabaseKey"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="eyJ...">
                </div>
                <button onclick="saveSetup()"
                    class="focusable w-full px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                    Salvar Configura√ß√µes
                </button>
                <button onclick="testGitHubConnection()"
                    class="focusable w-full px-4 py-3 bg-blue-600 hover:bg-blue-500 text-zinc-50 font-medium rounded-md">
                    üîç Testar Conex√£o GitHub
                </button>
            </div>
            <div id="setupStatus" class="hidden mt-4"></div>
        </div>
    </div>
    <!-- Setup Modal (Initial Configuration) -->
    <div id="setupModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div
            class="bg-zinc-900 border border-zinc-800 rounded-md p-6 max-w-2xl mx-4 w-full max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-zinc-50">Configura√ß√£o Inicial</h3>
                <button onclick="closeSetupModal()"
                    class="focusable text-zinc-400 hover:text-zinc-50 text-2xl">&times;</button>
            </div>
            <p class="text-sm text-zinc-400 mb-6">Configure suas credenciais do Supabase e GitHub para usar a loja de
                APKs.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Supabase URL</label>
                    <input type="text" id="setupModalSupabaseUrl"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="https://xxx.supabase.co">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Supabase Anon Key</label>
                    <input type="password" id="setupModalSupabaseKey"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="eyJ...">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">GitHub Token (opcional, para upload)</label>
                    <input type="password" id="setupModalGithubToken"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="ghp_...">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">GitHub Repo Path (opcional, para upload)</label>
                    <input type="text" id="setupModalGithubRepo"
                        class="focusable w-full px-4 py-2 bg-zinc-950 border border-zinc-800 rounded-md text-zinc-50"
                        placeholder="usuario/repositorio">
                </div>
                <button onclick="saveSetupFromModal()"
                    class="focusable w-full px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                    Salvar e Fechar
                </button>
            </div>
            <div id="setupModalStatus" class="hidden mt-4"></div>
        </div>
    </div>
    <!-- Help Modal -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-zinc-900 border border-zinc-800 rounded-md p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-zinc-50">Como Instalar APKs</h3>
                <button onclick="closeHelpModal()"
                    class="focusable text-zinc-400 hover:text-zinc-50 text-2xl">&times;</button>
            </div>
            <div class="space-y-4 text-zinc-300">
                <div class="flex items-start gap-3">
                    <div
                        class="flex-shrink-0 w-8 h-8 bg-yellow-500 text-zinc-950 rounded-full flex items-center justify-center font-bold">
                        1</div>
                    <div>
                        <h4 class="font-semibold text-zinc-50 mb-1">Habilitar Fontes Desconhecidas</h4>
                        <p class="text-sm">V√° em <strong>Configura√ß√µes ‚Üí Seguran√ßa</strong> e ative a op√ß√£o
                            <strong>"Fontes desconhecidas"</strong> ou <strong>"Instalar apps desconhecidos"</strong>.
                        </p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div
                        class="flex-shrink-0 w-8 h-8 bg-yellow-500 text-zinc-950 rounded-full flex items-center justify-center font-bold">
                        2</div>
                    <div>
                        <h4 class="font-semibold text-zinc-50 mb-1">Baixar o APK</h4>
                        <p class="text-sm">Clique no aplicativo desejado e toque em <strong>"Download"</strong>. O
                            arquivo ser√° salvo na pasta Downloads.</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div
                        class="flex-shrink-0 w-8 h-8 bg-yellow-500 text-zinc-950 rounded-full flex items-center justify-center font-bold">
                        3</div>
                    <div>
                        <h4 class="font-semibold text-zinc-50 mb-1">Instalar o APK</h4>
                        <p class="text-sm">Abra o gerenciador de arquivos, v√° at√© <strong>Downloads</strong>, toque no
                            arquivo APK e siga as instru√ß√µes na tela.</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div
                        class="flex-shrink-0 w-8 h-8 bg-yellow-500 text-zinc-950 rounded-full flex items-center justify-center font-bold">
                        4</div>
                    <div>
                        <h4 class="font-semibold text-zinc-50 mb-1">Abrir o App</h4>
                        <p class="text-sm">Ap√≥s a instala√ß√£o, o √≠cone aparecer√° na lista de aplicativos. Toque para
                            abrir!</p>
                    </div>
                </div>
            </div>
            <button onclick="closeHelpModal()"
                class="focusable mt-6 w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md">
                Entendi
            </button>
        </div>
    </div>
    <script>
        // Global state
        var supabaseClient = null;
        var allApps = [];
        var currentView = 'store';
        // Initialize app on load
        window.addEventListener('load', function () {
            initApp();
        });
        // Initialize application
        function initApp() {
            setupRouter();
            loadSetup();
            setupKeyboardNav();
            // Load store data
            if (window.location.hash === '' || window.location.hash === '#/') {
                renderStore();
            }
        }
        // Setup hash-based routing
        function setupRouter() {
            window.addEventListener('hashchange', handleRoute);
            handleRoute();
        }
        // Handle route changes
        function handleRoute() {
            var hash = window.location.hash;
            // Hide all views
            document.getElementById('storeView').classList.add('hidden');
            document.getElementById('adminLoginView').classList.add('hidden');
            document.getElementById('adminDashboardView').classList.add('hidden');
            // Show appropriate view
            if (hash === '' || hash === '#/') {
                document.getElementById('storeView').classList.remove('hidden');
                currentView = 'store';
                renderStore();
            } else if (hash === '#/admin') {
                document.getElementById('adminLoginView').classList.remove('hidden');
                currentView = 'adminLogin';
            } else if (hash === '#/admin/dashboard') {
                var isAuthenticated = localStorage.getItem('adminAuth') === 'true';
                if (isAuthenticated) {
                    document.getElementById('adminDashboardView').classList.remove('hidden');
                    currentView = 'adminDashboard';
                    loadSetupValues();
                } else {
                    navigateTo('#/admin');
                }
            } else {
                navigateTo('#/');
            }
        }
        // Navigate to route
        function navigateTo(route) {
            window.location.hash = route;
        }
        // Load setup from localStorage
        function loadSetup() {
            var supabaseUrl = localStorage.getItem('supabaseUrl');
            var supabaseKey = localStorage.getItem('supabaseKey');
            if (supabaseUrl && supabaseKey) {
                try {
                    supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                } catch (error) {
                    console.error('Erro ao conectar com Supabase:', error);
                }
            }
        }
        // Render store view
        function renderStore() {
            if (!supabaseClient) {
                showEmptyState('Configure o Supabase no painel Admin primeiro.');
                return;
            }
            document.getElementById('storeLoading').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            supabaseClient
                .from('aplicativos')
                .select('*')
                .order('data_upload', { ascending: false })
                .then(function (response) {
                    document.getElementById('storeLoading').classList.add('hidden');
                    if (response.error) {
                        console.error('Erro ao carregar apps:', response.error);
                        showEmptyState('Erro ao carregar aplicativos.');
                        return;
                    }
                    allApps = response.data || [];
                    displayApps(allApps);
                })
                .catch(function (error) {
                    console.error('Erro:', error);
                    document.getElementById('storeLoading').classList.add('hidden');
                    showEmptyState('Erro ao conectar com o servidor.');
                });
        }
        // Display apps in grid
        function displayApps(apps) {
            var appList = document.getElementById('appList');
            if (!apps || apps.length === 0) {
                appList.innerHTML = '';
                showEmptyState('Nenhum aplicativo dispon√≠vel.');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');
            var html = '';
            for (var i = 0; i < apps.length; i++) {
                var app = apps[i];
                var iconHtml = app.icone_url
                    ? '<img src="' + app.icone_url + '" alt="' + app.nome + '" class="w-16 h-16 rounded-md object-cover">'
                    : generateFallbackIcon(app.nome);
                var sizeText = app.tamanho_mb ? app.tamanho_mb + ' MB' : 'N/A';
                var versionText = app.versao ? 'Vers√£o ' + app.versao : 'Sem vers√£o';
                var description = app.descricao || 'Sem descri√ß√£o';
                var category = app.categoria ? '<span class="inline-block px-2 py-1 text-xs bg-zinc-800 text-zinc-300 rounded">' + app.categoria + '</span>' : '';
                html += '<div class="bg-zinc-900 border border-zinc-800 rounded-md p-4 hover:border-zinc-700 transition-colors">';
                html += '  <div class="flex items-start gap-4 mb-3">';
                html += '    ' + iconHtml;
                html += '    <div class="flex-1 min-w-0">';
                html += '      <h3 class="text-lg font-semibold text-zinc-50 truncate">' + app.nome + '</h3>';
                html += '      <p class="text-sm text-zinc-400">' + versionText + '</p>';
                html += '      <p class="text-sm text-zinc-500">' + sizeText + '</p>';
                if (category) html += '      <div class="mt-1">' + category + '</div>';
                html += '    </div>';
                html += '  </div>';
                html += '  <p class="text-sm text-zinc-400 mb-4 line-clamp-2">' + description + '</p>';
                html += '  <a href="' + app.apk_url + '" download class="focusable block w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-zinc-950 font-medium rounded-md text-center text-sm">';
                html += '    Download';
                html += '  </a>';
                html += '</div>';
            }
            appList.innerHTML = html;
        }
        // Filter apps by search
        function filterApps() {
            var searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                displayApps(allApps);
                return;
            }
            var filtered = [];
            for (var i = 0; i < allApps.length; i++) {
                var app = allApps[i];
                var matchName = app.nome.toLowerCase().indexOf(searchTerm) !== -1;
                var matchDesc = app.descricao && app.descricao.toLowerCase().indexOf(searchTerm) !== -1;
                if (matchName || matchDesc) {
                    filtered.push(app);
                }
            }
            displayApps(filtered);
        }
        // Generate fallback icon (circle with initial)
        function generateFallbackIcon(name) {
            var initial = name.charAt(0).toUpperCase();
            var colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];
            var colorIndex = name.charCodeAt(0) % colors.length;
            var color = colors[colorIndex];
            var svg = '<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">';
            svg += '<circle cx="32" cy="32" r="32" fill="' + color + '"/>';
            svg += '<text x="32" y="42" text-anchor="middle" fill="white" font-size="28" font-weight="bold" font-family="system-ui">' + initial + '</text>';
            svg += '</svg>';
            return '<div class="w-16 h-16 rounded-md overflow-hidden">' + svg + '</div>';
        }
        // Show empty state
        function showEmptyState(message) {
            var emptyState = document.getElementById('emptyState');
            emptyState.classList.remove('hidden');
            emptyState.querySelector('p').textContent = message || 'Nenhum aplicativo encontrado.';
            document.getElementById('appList').innerHTML = '';
        }
        // Validate PIN
        function validatePIN() {
            if (!supabaseClient) {
                showError('loginError', 'Configure o Supabase primeiro no painel Admin.');
                return;
            }
            var pin = document.getElementById('pinInput').value;
            if (!pin) {
                showError('loginError', 'Digite o PIN.');
                return;
            }
            supabaseClient
                .from('configuracoes')
                .select('pin_acesso')
                .limit(1)
                .single()
                .then(function (response) {
                    if (response.error) {
                        showError('loginError', 'Erro ao validar PIN.');
                        return;
                    }
                    if (response.data && response.data.pin_acesso === pin) {
                        localStorage.setItem('adminAuth', 'true');
                        navigateTo('#/admin/dashboard');
                    } else {
                        showError('loginError', 'PIN incorreto.');
                    }
                })
                .catch(function (error) {
                    console.error('Erro:', error);
                    showError('loginError', 'Erro ao conectar com o servidor.');
                });
        }
        // Logout
        function logout() {
            localStorage.removeItem('adminAuth');
            navigateTo('#/admin');
        }
        // Switch admin tabs
        function switchTab(tab) {
            // Update tab buttons
            var tabUpload = document.getElementById('tabUpload');
            var tabSetup = document.getElementById('tabSetup');
            tabUpload.classList.remove('border-yellow-500', 'text-yellow-500');
            tabUpload.classList.add('border-transparent', 'text-zinc-400');
            tabSetup.classList.remove('border-yellow-500', 'text-yellow-500');
            tabSetup.classList.add('border-transparent', 'text-zinc-400');
            // Show active tab
            if (tab === 'upload') {
                document.getElementById('uploadTab').classList.remove('hidden');
                document.getElementById('setupTab').classList.add('hidden');
                tabUpload.classList.add('border-yellow-500', 'text-yellow-500');
                tabUpload.classList.remove('border-transparent', 'text-zinc-400');
            } else {
                document.getElementById('uploadTab').classList.add('hidden');
                document.getElementById('setupTab').classList.remove('hidden');
                tabSetup.classList.add('border-yellow-500', 'text-yellow-500');
                tabSetup.classList.remove('border-transparent', 'text-zinc-400');
            }
        }
        // Save setup to localStorage
        function saveSetup() {
            var githubToken = document.getElementById('githubToken').value;
            var githubRepo = document.getElementById('githubRepo').value;
            var supabaseUrl = document.getElementById('supabaseUrl').value;
            var supabaseKey = document.getElementById('supabaseKey').value;
            if (!githubToken || !githubRepo || !supabaseUrl || !supabaseKey) {
                showStatus('setupStatus', 'Preencha todos os campos.', 'error');
                return;
            }
            localStorage.setItem('githubToken', githubToken);
            localStorage.setItem('githubRepo', githubRepo);
            localStorage.setItem('supabaseUrl', supabaseUrl);
            localStorage.setItem('supabaseKey', supabaseKey);
            // Reinitialize Supabase client
            loadSetup();
            showStatus('setupStatus', 'Configura√ß√µes salvas com sucesso!', 'success');
        }
        // Load setup values into form
        function loadSetupValues() {
            document.getElementById('githubToken').value = localStorage.getItem('githubToken') || '';
            document.getElementById('githubRepo').value = localStorage.getItem('githubRepo') || '';
            document.getElementById('supabaseUrl').value = localStorage.getItem('supabaseUrl') || '';
            document.getElementById('supabaseKey').value = localStorage.getItem('supabaseKey') || '';
        }
        // Test GitHub connection and credentials
        function testGitHubConnection() {
            var githubToken = localStorage.getItem('githubToken');
            var githubRepo = localStorage.getItem('githubRepo');
            // Clear previous status
            showStatus('setupStatus', '', 'info');
            // Step 1: Validate credentials exist
            if (!githubToken || !githubRepo) {
                showStatus('setupStatus', '‚ùå Erro: Configure GitHub Token e Repo primeiro!', 'error');
                return;
            }
            // Step 2: Validate token format
            if (!githubToken.startsWith('ghp_') && !githubToken.startsWith('github_pat_')) {
                showStatus('setupStatus', '‚ö†Ô∏è Aviso: Token GitHub n√£o parece ter formato v√°lido (deve come√ßar com ghp_ ou github_pat_)', 'error');
                return;
            }
            // Step 3: Validate repo format
            if (githubRepo.split('/').length !== 2) {
                showStatus('setupStatus', '‚ùå Erro: Formato do reposit√≥rio inv√°lido. Use: usuario/repositorio', 'error');
                return;
            }
            showStatus('setupStatus', 'üîÑ Testando conex√£o com GitHub API...', 'info');
            // Step 4: Test API connection
            fetch('https://api.github.com/repos/' + githubRepo, {
                method: 'GET',
                headers: {
                    'Authorization': 'token ' + githubToken,
                    'Accept': 'application/vnd.github.v3+json'
                }
            })
                .then(function (response) {
                    if (response.status === 404) {
                        throw new Error('Reposit√≥rio n√£o encontrado. Verifique se o nome est√° correto e se existe.');
                    }
                    if (response.status === 401) {
                        throw new Error('Token inv√°lido ou expirado. Gere um novo token no GitHub.');
                    }
                    if (response.status === 403) {
                        throw new Error('Token sem permiss√µes necess√°rias. Certifique-se de marcar o escopo "repo".');
                    }
                    if (!response.ok) {
                        throw new Error('Erro HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(function (repo) {
                    var message = '‚úÖ Sucesso! Conex√£o OK\\n\\n';
                    message += 'üì¶ Reposit√≥rio: ' + repo.full_name + '\\n';
                    message += 'üîí Privado: ' + (repo.private ? 'Sim' : 'N√£o') + '\\n';
                    message += '‚úçÔ∏è Propriet√°rio: ' + repo.owner.login + '\\n';
                    message += 'üìù Descri√ß√£o: ' + (repo.description || 'Sem descri√ß√£o');
                    showStatus('setupStatus', message, 'success');
                })
                .catch(function (error) {
                    var message = '‚ùå Erro ao conectar:\\n\\n';
                    message += error.message + '\\n\\n';
                    message += 'üìã Verifique:\\n';
                    message += '‚Ä¢ Token tem escopo "repo" ativado\\n';
                    message += '‚Ä¢ Reposit√≥rio existe e est√° acess√≠vel\\n';
                    message += '‚Ä¢ Token n√£o expirou';
                    showStatus('setupStatus', message, 'error');
                    console.error('Erro detalhado:', error);
                });
        }
        // Upload APK to GitHub Releases
        function uploadAPK() {
            var name = document.getElementById('appName').value;
            var version = document.getElementById('appVersion').value;
            var description = document.getElementById('appDescription').value;
            var category = document.getElementById('appCategory').value;
            var iconInput = document.getElementById('iconFile');
            var iconFile = iconInput.files[0];
            var fileInput = document.getElementById('apkFile');
            var file = fileInput.files[0];
            // Validation - only APK is required
            if (!file) {
                showStatus('uploadStatus', 'Selecione o arquivo APK.', 'error');
                return;
            }
            if (!supabaseClient) {
                showStatus('uploadStatus', 'Configure o Supabase primeiro.', 'error');
                return;
            }
            var githubToken = localStorage.getItem('githubToken');
            var githubRepo = localStorage.getItem('githubRepo');
            if (!githubToken || !githubRepo) {
                showStatus('uploadStatus', 'Configure GitHub Token e Repo na aba Setup.', 'error');
                return;
            }
            // Disable button
            var uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<div class="spinner mx-auto"></div>';
            // Step 0.1: Auto-fill name from APK filename if empty
            if (!name) {
                name = file.name.replace('.apk', '').replace(/[_-]/g, ' ');
                // Capitalize first letter
                name = name.charAt(0).toUpperCase() + name.slice(1);
                showStatus('uploadStatus', 'Nome detectado do arquivo: ' + name, 'info');
            }
            var processUpload = function (finalVersion) {
                version = finalVersion;
                var iconUrl = null;
                var uploadPromise = Promise.resolve();
                // Step 1: Upload icon to Supabase Storage (if provided)
                if (iconFile) {
                    showStatus('uploadStatus', 'Fazendo upload do √≠cone...', 'info');
                    var iconFileName = Date.now() + '_' + iconFile.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                    uploadPromise = supabaseClient.storage
                        .from('app-icons')
                        .upload(iconFileName, iconFile, {
                            cacheControl: '3600',
                            upsert: false
                        })
                        .then(function (response) {
                            if (response.error) {
                                throw new Error('Erro ao fazer upload do √≠cone: ' + response.error.message);
                            }
                            // Get public URL
                            var publicUrlData = supabaseClient.storage
                                .from('app-icons')
                                .getPublicUrl(iconFileName);
                            iconUrl = publicUrlData.data.publicUrl;
                            showStatus('uploadStatus', '√çcone enviado! Fazendo upload para GitHub Releases...', 'info');
                        });
                } else {
                    showStatus('uploadStatus', 'Fazendo upload para GitHub Releases...', 'info');
                }
                uploadPromise
                    .then(function () {
                        // Step 2: Create release
                        var releaseTag = 'v' + version + '-' + Date.now();
                        var releaseData = {
                            tag_name: releaseTag,
                            name: name + ' v' + version,
                            body: description || 'Release via APK Store',
                            draft: false,
                            prerelease: false
                        };
                        return fetch('https://api.github.com/repos/' + githubRepo + '/releases', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'token ' + githubToken,
                                'Content-Type': 'application/json',
                                'Accept': 'application/vnd.github.v3+json'
                            },
                            body: JSON.stringify(releaseData)
                        });
                    })
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (release) {
                        // Check for errors in response
                        if (release.message) {
                            var errorMsg = 'Erro GitHub: ' + release.message;
                            if (release.errors) {
                                errorMsg += '\nDetalhes: ' + JSON.stringify(release.errors);
                            }
                            if (release.documentation_url) {
                                errorMsg += '\nDoc: ' + release.documentation_url;
                            }
                            throw new Error(errorMsg);
                        }
                        
                        if (!release.upload_url) {
                            throw new Error('Falha ao criar release. Resposta: ' + JSON.stringify(release));
                        }
                        showStatus('uploadStatus', 'Release criada. Fazendo upload do APK...', 'info');
                        // Step 3: Upload asset
                        var uploadUrl = release.upload_url.replace('{?name,label}', '?name=' + encodeURIComponent(file.name));
                        return fetch(uploadUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': 'token ' + githubToken,
                                'Content-Type': 'application/vnd.android.package-archive',
                                'Accept': 'application/vnd.github.v3+json'
                            },
                            body: file
                        });
                    })
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (asset) {
                        if (!asset.browser_download_url) {
                            throw new Error('Falha ao fazer upload do APK.');
                        }
                        showStatus('uploadStatus', 'APK enviado. Salvando no Supabase...', 'info');
                        // Step 4: Save to Supabase with ALL fields
                        var fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                        return supabaseClient
                            .from('aplicativos')
                            .insert([{
                                nome: name,
                                versao: version,
                                descricao: description || null,
                                categoria: category || null,
                                icone_url: iconUrl || null,
                                apk_url: asset.browser_download_url,
                                tamanho_mb: parseFloat(fileSizeMB),
                                data_upload: new Date().toISOString()
                            }]);
                    })
                    .then(function (response) {
                        if (response.error) {
                            throw new Error('Erro ao salvar no Supabase: ' + response.error.message);
                        }
                        showStatus('uploadStatus', 'Upload conclu√≠do com sucesso! (v' + version + ')', 'success');
                        // Clear form
                        document.getElementById('appName').value = '';
                        document.getElementById('appVersion').value = '';
                        document.getElementById('appDescription').value = '';
                        document.getElementById('appCategory').value = '';
                        document.getElementById('iconFile').value = '';
                        fileInput.value = '';
                        // Re-enable button
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload para GitHub Releases';
                    })
                    .catch(function (error) {
                        console.error('Erro no upload:', error);
                        showStatus('uploadStatus', 'Erro: ' + error.message, 'error');
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload para GitHub Releases';
                    });
            };
            // Step 0.2: Auto-detect version if empty
            if (!version) {
                showStatus('uploadStatus', 'Detectando vers√£o automaticamente...', 'info');
                // Query existing versions of this app
                supabaseClient
                    .from('aplicativos')
                    .select('versao')
                    .eq('nome', name)
                    .order('created_at', { ascending: false })
                    .then(function (response) {
                        if (response.error) {
                            console.warn('Erro ao buscar vers√µes:', response.error);
                            processUpload('1.0');
                            return;
                        }
                        var existingVersions = response.data || [];
                        if (existingVersions.length === 0) {
                            // No existing versions, start with 1.0
                            processUpload('1.0');
                        } else {
                            // Find highest version and increment
                            var maxVersion = 1.0;
                            for (var i = 0; i < existingVersions.length; i++) {
                                var v = parseFloat(existingVersions[i].versao);
                                if (!isNaN(v) && v >= maxVersion) {
                                    maxVersion = v;
                                }
                            }
                            // Increment by 0.1
                            var newVersion = (maxVersion + 0.1).toFixed(1);
                            processUpload(newVersion);
                        }
                    })
                    .catch(function (error) {
                        console.error('Erro ao verificar vers√µes:', error);
                        processUpload('1.0');
                    });
            } else {
                // Version provided, proceed directly
                processUpload(version);
            }
        }
        // Show status message
        function showStatus(elementId, message, type) {
            var element = document.getElementById(elementId);
            element.classList.remove('hidden');
            var bgColor = type === 'error' ? 'bg-red-950 border-red-900 text-red-200' :
                type === 'success' ? 'bg-green-950 border-green-900 text-green-200' :
                    'bg-blue-950 border-blue-900 text-blue-200';
            element.className = 'mt-4 p-3 rounded-md text-sm border ' + bgColor;
            element.textContent = message;
        }
        // Show error message
        function showError(elementId, message) {
            var element = document.getElementById(elementId);
            element.classList.remove('hidden');
            element.textContent = message;
        }
        // Open help modal
        function openHelpModal() {
            document.getElementById('helpModal').classList.remove('hidden');
        }
        // Close help modal
        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
        }
        // Open setup modal
        function openSetupModal() {
            // Load existing values if any
            document.getElementById('setupModalSupabaseUrl').value = localStorage.getItem('supabaseUrl') || '';
            document.getElementById('setupModalSupabaseKey').value = localStorage.getItem('supabaseKey') || '';
            document.getElementById('setupModalGithubToken').value = localStorage.getItem('githubToken') || '';
            document.getElementById('setupModalGithubRepo').value = localStorage.getItem('githubRepo') || '';
            document.getElementById('setupModal').classList.remove('hidden');
        }
        // Close setup modal
        function closeSetupModal() {
            document.getElementById('setupModal').classList.add('hidden');
        }
        // Save setup from modal
        function saveSetupFromModal() {
            var supabaseUrl = document.getElementById('setupModalSupabaseUrl').value;
            var supabaseKey = document.getElementById('setupModalSupabaseKey').value;
            var githubToken = document.getElementById('setupModalGithubToken').value;
            var githubRepo = document.getElementById('setupModalGithubRepo').value;
            if (!supabaseUrl || !supabaseKey) {
                showStatus('setupModalStatus', 'Preencha pelo menos a URL e a chave do Supabase.', 'error');
                return;
            }
            localStorage.setItem('supabaseUrl', supabaseUrl);
            localStorage.setItem('supabaseKey', supabaseKey);
            if (githubToken) localStorage.setItem('githubToken', githubToken);
            if (githubRepo) localStorage.setItem('githubRepo', githubRepo);
            // Reinitialize Supabase client
            loadSetup();
            showStatus('setupModalStatus', 'Configura√ß√µes salvas! Voc√™ j√° pode fazer login com o PIN.', 'success');
            setTimeout(function () {
                closeSetupModal();
            }, 2000);
        }
        // Setup keyboard navigation for D-Pad
        function setupKeyboardNav() {
            var focusableElements = [];
            var currentFocusIndex = -1;
            // Update focusable elements list
            function updateFocusableElements() {
                focusableElements = Array.prototype.slice.call(
                    document.querySelectorAll('.focusable:not([disabled])')
                ).filter(function (el) {
                    return el.offsetParent !== null; // Only visible elements
                });
            }
            // Handle keyboard events
            document.addEventListener('keydown', function (e) {
                updateFocusableElements();
                if (focusableElements.length === 0) return;
                // Arrow Down or Tab
                if (e.key === 'ArrowDown' || (e.key === 'Tab' && !e.shiftKey)) {
                    e.preventDefault();
                    currentFocusIndex = (currentFocusIndex + 1) % focusableElements.length;
                    focusableElements[currentFocusIndex].focus();
                }
                // Arrow Up or Shift+Tab
                else if (e.key === 'ArrowUp' || (e.key === 'Tab' && e.shiftKey)) {
                    e.preventDefault();
                    currentFocusIndex = currentFocusIndex <= 0 ? focusableElements.length - 1 : currentFocusIndex - 1;
                    focusableElements[currentFocusIndex].focus();
                }
                // Escape - close modals
                else if (e.key === 'Escape') {
                    closeHelpModal();
                }
            });
            // Track current focus
            document.addEventListener('focus', function (e) {
                var index = focusableElements.indexOf(e.target);
                if (index !== -1) {
                    currentFocusIndex = index;
                }
            }, true);
        }
        // Close modal on overlay click
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('modal-overlay')) {
                closeHelpModal();
                closeSetupModal();
            }
        });
    </script>
</body>
</html>
